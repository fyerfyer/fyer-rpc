"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[462],{2071:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"advanced/metric/metric","title":"Monitor & Metrics","description":"\u76d1\u63a7\u662f\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u5173\u952e\u7ec4\u4ef6\uff0c\u5e2e\u52a9\u5f00\u53d1\u8005\u4e86\u89e3\u7cfb\u7edf\u8fd0\u884c\u72b6\u51b5\u3001\u6027\u80fd\u74f6\u9888\u4ee5\u53ca\u95ee\u9898\u6392\u67e5\u3002","source":"@site/docs/advanced/metric/metric.md","sourceDirName":"advanced/metric","slug":"/advanced/metric/","permalink":"/fyer-rpc/docs/advanced/metric/","draft":false,"unlisted":false,"editUrl":"https://github.com/fyerfyer/fyer-rpc/tree/main/docs/advanced/metric/metric.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Load Balance","permalink":"/fyer-rpc/docs/advanced/load-balancer/"},"next":{"title":"Service Registry & Discovery","permalink":"/fyer-rpc/docs/advanced/service registry&discovery/"}}');var s=n(4848),i=n(8453);const c={},l="Monitor & Metrics",o={},a=[{value:"\u6307\u6807\u6536\u96c6",id:"\u6307\u6807\u6536\u96c6",level:2},{value:"\u5173\u952e\u6307\u6807",id:"\u5173\u952e\u6307\u6807",level:3},{value:"\u6307\u6807\u63a5\u53e3",id:"\u6307\u6807\u63a5\u53e3",level:3},{value:"\u54cd\u5e94\u6307\u6807",id:"\u54cd\u5e94\u6307\u6807",level:3},{value:"\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668",id:"\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668",level:3},{value:"\u7a7a\u64cd\u4f5c\u6307\u6807\u6536\u96c6\u5668",id:"\u7a7a\u64cd\u4f5c\u6307\u6807\u6536\u96c6\u5668",level:3},{value:"Prometheus\u96c6\u6210",id:"prometheus\u96c6\u6210",level:2},{value:"Prometheus\u7b80\u4ecb",id:"prometheus\u7b80\u4ecb",level:3},{value:"PrometheusMetrics",id:"prometheusmetrics",level:3},{value:"\u5173\u952e\u6307\u6807\u5b9a\u4e49",id:"\u5173\u952e\u6307\u6807\u5b9a\u4e49",level:3},{value:"\u4f7f\u7528PrometheusMetrics",id:"\u4f7f\u7528prometheusmetrics",level:3},{value:"\u67e5\u8be2\u6307\u6807\u6570\u636e",id:"\u67e5\u8be2\u6307\u6807\u6570\u636e",level:3},{value:"\u76d1\u63a7\u914d\u7f6e",id:"\u76d1\u63a7\u914d\u7f6e",level:2},{value:"\u5ba2\u6237\u7aef\u76d1\u63a7\u914d\u7f6e",id:"\u5ba2\u6237\u7aef\u76d1\u63a7\u914d\u7f6e",level:3},{value:"\u670d\u52a1\u7aef\u76d1\u63a7\u914d\u7f6e",id:"\u670d\u52a1\u7aef\u76d1\u63a7\u914d\u7f6e",level:3},{value:"\u96c6\u6210Prometheus\u76d1\u63a7\u6808",id:"\u96c6\u6210prometheus\u76d1\u63a7\u6808",level:2},{value:"Prometheus\u914d\u7f6e",id:"prometheus\u914d\u7f6e",level:3},{value:"Grafana\u4eea\u8868\u677f",id:"grafana\u4eea\u8868\u677f",level:3},{value:"\u81ea\u5b9a\u4e49\u6307\u6807\u6536\u96c6\u5668",id:"\u81ea\u5b9a\u4e49\u6307\u6807\u6536\u96c6\u5668",level:2},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u9009\u62e9\u5408\u9002\u7684\u6307\u6807\u6536\u96c6\u65b9\u5f0f",id:"\u9009\u62e9\u5408\u9002\u7684\u6307\u6807\u6536\u96c6\u65b9\u5f0f",level:3},{value:"\u4f18\u5316\u6307\u6807\u6536\u96c6",id:"\u4f18\u5316\u6307\u6807\u6536\u96c6",level:3},{value:"\u544a\u8b66\u914d\u7f6e",id:"\u544a\u8b66\u914d\u7f6e",level:3},{value:"\u6269\u5c55\u76d1\u63a7\u8303\u56f4",id:"\u6269\u5c55\u76d1\u63a7\u8303\u56f4",level:3},{value:"\u793a\u4f8b\uff1a\u5b8c\u6574\u76d1\u63a7\u914d\u7f6e",id:"\u793a\u4f8b\u5b8c\u6574\u76d1\u63a7\u914d\u7f6e",level:2}];function d(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"monitor--metrics",children:"Monitor & Metrics"})}),"\n",(0,s.jsx)(r.p,{children:"\u76d1\u63a7\u662f\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u5173\u952e\u7ec4\u4ef6\uff0c\u5e2e\u52a9\u5f00\u53d1\u8005\u4e86\u89e3\u7cfb\u7edf\u8fd0\u884c\u72b6\u51b5\u3001\u6027\u80fd\u74f6\u9888\u4ee5\u53ca\u95ee\u9898\u6392\u67e5\u3002"}),"\n",(0,s.jsx)(r.h2,{id:"\u6307\u6807\u6536\u96c6",children:"\u6307\u6807\u6536\u96c6"}),"\n",(0,s.jsx)(r.h3,{id:"\u5173\u952e\u6307\u6807",children:"\u5173\u952e\u6307\u6807"}),"\n",(0,s.jsx)(r.p,{children:"fyerrpc\u76d1\u63a7\u7cfb\u7edf\u6536\u96c6\u5e76\u66b4\u9732\u4ee5\u4e0b\u5173\u952e\u6307\u6807\uff1a"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u54cd\u5e94\u65f6\u95f4"}),"\uff1aRPC\u8c03\u7528\u7684\u5ef6\u8fdf\u65f6\u95f4\u5206\u5e03"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u8bf7\u6c42\u8ba1\u6570"}),"\uff1a\u6210\u529f\u548c\u5931\u8d25\u7684\u8bf7\u6c42\u603b\u6570"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u9519\u8bef\u7387"}),"\uff1aRPC\u8c03\u7528\u7684\u9519\u8bef\u6bd4\u7387"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u6545\u969c\u8f6c\u79fb"}),"\uff1a\u6545\u969c\u8f6c\u79fb\u4e8b\u4ef6\u8ba1\u6570\u548c\u76f8\u5173\u7edf\u8ba1"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u7194\u65ad\u72b6\u6001"}),"\uff1a\u7194\u65ad\u5668\u72b6\u6001\u53d8\u66f4\u548c\u7edf\u8ba1"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u91cd\u8bd5\u6b21\u6570"}),"\uff1aRPC\u8bf7\u6c42\u7684\u91cd\u8bd5\u7edf\u8ba1"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"\u6307\u6807\u63a5\u53e3",children:"\u6307\u6807\u63a5\u53e3"}),"\n",(0,s.jsxs)(r.p,{children:["fyerrpc\u4f7f\u7528",(0,s.jsx)(r.code,{children:"metrics.Metrics"}),"\u63a5\u53e3\u5b9a\u4e49\u4e86\u6307\u6807\u6536\u96c6\u7684\u6807\u51c6\u884c\u4e3a\uff1a"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"type Metrics interface {\r\n    // RecordResponse \u8bb0\u5f55\u54cd\u5e94\u65f6\u95f4\r\n    RecordResponse(ctx context.Context, metric *ResponseMetric) error\r\n\r\n    // GetLatency \u83b7\u53d6\u6307\u5b9a\u670d\u52a1\u5b9e\u4f8b\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\r\n    GetLatency(ctx context.Context, service, instance string) (time.Duration, error)\r\n\r\n    // GetServiceLatency \u83b7\u53d6\u670d\u52a1\u6240\u6709\u5b9e\u4f8b\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\r\n    GetServiceLatency(ctx context.Context, service string) (map[string]time.Duration, error)\r\n\r\n    // RecordFailover \u8bb0\u5f55\u6545\u969c\u8f6c\u79fb\u4e8b\u4ef6\r\n    RecordFailover(ctx context.Context, service, fromInstance, toInstance string) error\r\n\r\n    // RecordCircuitBreak \u8bb0\u5f55\u7194\u65ad\u4e8b\u4ef6\r\n    RecordCircuitBreak(ctx context.Context, service, instance string, state string) error\r\n\r\n    // RecordRetry \u8bb0\u5f55\u91cd\u8bd5\u4e8b\u4ef6\r\n    RecordRetry(ctx context.Context, service, instance string, attempt int) error\r\n\r\n    // GetFailoverRate \u83b7\u53d6\u6545\u969c\u8f6c\u79fb\u7387\r\n    GetFailoverRate(ctx context.Context, service string) (float64, error)\r\n\r\n    // Close \u5173\u95ed\u6307\u6807\u6536\u96c6\u5668\r\n    Close() error\r\n}\n"})}),"\n",(0,s.jsx)(r.h3,{id:"\u54cd\u5e94\u6307\u6807",children:"\u54cd\u5e94\u6307\u6807"}),"\n",(0,s.jsxs)(r.p,{children:["\u6bcf\u4e2aRPC\u8c03\u7528\u7684\u6307\u6807\u6570\u636e\u4f7f\u7528",(0,s.jsx)(r.code,{children:"ResponseMetric"}),"\u7ed3\u6784\u4f53\u8868\u793a\uff1a"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"type ResponseMetric struct {\r\n    ServiceName string            // \u670d\u52a1\u540d\u79f0\r\n    MethodName  string            // \u65b9\u6cd5\u540d\u79f0\r\n    Instance    string            // \u5b9e\u4f8b\u5730\u5740\r\n    Duration    time.Duration     // \u54cd\u5e94\u65f6\u95f4\r\n    Status      string            // \u8c03\u7528\u72b6\u6001 (success/error)\r\n    Timestamp   time.Time         // \u8bb0\u5f55\u65f6\u95f4\u6233\r\n    Tags        map[string]string // \u989d\u5916\u7684\u6807\u7b7e\u4fe1\u606f\r\n}\n"})}),"\n",(0,s.jsx)(r.h3,{id:"\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668",children:"\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668"}),"\n",(0,s.jsx)(r.p,{children:"\u5f53\u4e0d\u9700\u8981\u5916\u90e8\u76d1\u63a7\u7cfb\u7edf\u65f6\uff0cfyerrpc\u63d0\u4f9b\u4e86\u5185\u7f6e\u7684\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668\uff0c\u9002\u7528\u4e8e\u6d4b\u8bd5\u3001\u8c03\u8bd5\u548c\u5c0f\u578b\u90e8\u7f72\u573a\u666f\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// \u521b\u5efa\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668\r\ncollector := failover.NewInMemoryMetricsCollector(100) // \u4fdd\u7559100\u4e2a\u5ef6\u8fdf\u6837\u672c\r\n\r\n// \u4f7f\u7528\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668\r\nresult, err := handler.Execute(ctx, instances, operation)\r\ncollector.RecordLatency(result.Instance, result.Duration)\r\n\r\n// \u83b7\u53d6\u7edf\u8ba1\u4fe1\u606f\r\navgLatency := collector.GetAverageLatency("instance-1")\r\nfailoverCount := collector.GetFailoverCount("user-service")\n'})}),"\n",(0,s.jsx)(r.h3,{id:"\u7a7a\u64cd\u4f5c\u6307\u6807\u6536\u96c6\u5668",children:"\u7a7a\u64cd\u4f5c\u6307\u6807\u6536\u96c6\u5668"}),"\n",(0,s.jsxs)(r.p,{children:["fyerrpc\u8fd8\u63d0\u4f9b\u4e86\u7a7a\u64cd\u4f5c\u6307\u6807\u6536\u96c6\u5668(",(0,s.jsx)(r.code,{children:"NoopMetrics"}),")\uff0c\u7528\u4e8e\u7981\u7528\u6307\u6807\u6536\u96c6\uff1a"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// \u521b\u5efa\u7a7a\u64cd\u4f5c\u6307\u6807\u6536\u96c6\u5668\r\nmetrics := metrics.NewNoopMetrics()\r\n\r\n// \u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7a7a\u64cd\u4f5c\u6307\u6807\u6536\u96c6\u5668\r\nconfig := &balancer.Config{\r\n    Type:           balancer.Random,\r\n    MetricsClient:  metrics,\r\n    UpdateInterval: 10,\r\n    RetryTimes:     3,\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"prometheus\u96c6\u6210",children:"Prometheus\u96c6\u6210"}),"\n",(0,s.jsx)(r.h3,{id:"prometheus\u7b80\u4ecb",children:"Prometheus\u7b80\u4ecb"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.a,{href:"https://prometheus.io/",children:"Prometheus"}),"\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u76d1\u63a7\u548c\u544a\u8b66\u7cfb\u7edf\uff0c\u4e13\u4e3a\u5fae\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1\uff0c\u5177\u6709\u4ee5\u4e0b\u7279\u70b9\uff1a"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"\u591a\u7ef4\u5ea6\u6570\u636e\u6a21\u578b\u548c\u67e5\u8be2\u8bed\u8a00"}),"\n",(0,s.jsx)(r.li,{children:"\u65e0\u9700\u4f9d\u8d56\u5916\u90e8\u5b58\u50a8\u7684\u65f6\u5e8f\u6570\u636e\u5e93"}),"\n",(0,s.jsx)(r.li,{children:"\u652f\u6301\u901a\u8fc7HTTP\u534f\u8bae\u8fdb\u884c\u62c9\u53d6\u5f0f\u6570\u636e\u6536\u96c6"}),"\n",(0,s.jsx)(r.li,{children:"\u652f\u6301\u901a\u8fc7\u4e2d\u95f4\u7f51\u5173\u8fdb\u884c\u63a8\u9001\u5f0f\u6570\u636e\u6536\u96c6"}),"\n",(0,s.jsx)(r.li,{children:"\u591a\u79cd\u56fe\u5f62\u548c\u4eea\u8868\u76d8\u652f\u6301"}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"prometheusmetrics",children:"PrometheusMetrics"}),"\n",(0,s.jsxs)(r.p,{children:["fyerrpc\u63d0\u4f9b\u4e86",(0,s.jsx)(r.code,{children:"PrometheusMetrics"}),"\u5b9e\u73b0\uff0c\u5c06\u6846\u67b6\u6307\u6807\u76f4\u63a5\u96c6\u6210\u5230Prometheus\u751f\u6001\uff1a"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// \u521b\u5efaPrometheus\u6307\u6807\u6536\u96c6\u5668\r\nmetricsClient, err := metrics.NewPrometheusMetrics(&metrics.PrometheusConfig{\r\n    PushGatewayURL: "http://localhost:9091", // Prometheus\u63a8\u9001\u7f51\u5173\u5730\u5740\r\n    QueryURL:       "http://localhost:9090", // Prometheus\u67e5\u8be2\u5730\u5740\r\n    JobName:        "fyerrpc",               // \u4f5c\u4e1a\u540d\u79f0\r\n    PushInterval:   time.Second * 10,        // \u63a8\u9001\u95f4\u9694\r\n})\r\nif err != nil {\r\n    log.Fatalf("Failed to create metrics client: %v", err)\r\n}\r\ndefer metricsClient.Close()\n'})}),"\n",(0,s.jsx)(r.h3,{id:"\u5173\u952e\u6307\u6807\u5b9a\u4e49",children:"\u5173\u952e\u6307\u6807\u5b9a\u4e49"}),"\n",(0,s.jsx)(r.p,{children:"fyerrpc\u4e3aPrometheus\u5b9a\u4e49\u4e86\u4ee5\u4e0b\u5173\u952e\u6307\u6807\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// \u54cd\u5e94\u65f6\u95f4\u76f4\u65b9\u56fe\r\nresponseTime := prometheus.NewHistogramVec(\r\n    prometheus.HistogramOpts{\r\n        Name:    "rpc_response_time_seconds",\r\n        Help:    "RPC response time in seconds",\r\n        Buckets: prometheus.DefBuckets,\r\n    },\r\n    []string{"service", "method", "instance", "status"},\r\n)\r\n\r\n// \u8bf7\u6c42\u603b\u6570\u8ba1\u6570\u5668\r\nrequestTotal := prometheus.NewCounterVec(\r\n    prometheus.CounterOpts{\r\n        Name: "rpc_requests_total",\r\n        Help: "Total number of RPC requests",\r\n    },\r\n    []string{"service", "method", "instance", "status"},\r\n)\r\n\r\n// \u6545\u969c\u8f6c\u79fb\u8ba1\u6570\u5668\r\nfailoverTotal := prometheus.NewCounterVec(\r\n    prometheus.CounterOpts{\r\n        Name: "rpc_failover_total",\r\n        Help: "Total number of failover events",\r\n    },\r\n    []string{"service", "from_instance", "to_instance"},\r\n)\r\n\r\n// \u7194\u65ad\u5668\u4e8b\u4ef6\u8ba1\u6570\u5668\r\ncircuitBreaks := prometheus.NewCounterVec(\r\n    prometheus.CounterOpts{\r\n        Name: "rpc_circuit_breaks_total",\r\n        Help: "Total number of circuit breaker state changes",\r\n    },\r\n    []string{"service", "instance", "state"},\r\n)\r\n\r\n// \u91cd\u8bd5\u8ba1\u6570\u5668\r\nretryTotal := prometheus.NewCounterVec(\r\n    prometheus.CounterOpts{\r\n        Name: "rpc_retry_total",\r\n        Help: "Total number of retry attempts",\r\n    },\r\n    []string{"service", "instance", "attempt"},\r\n)\r\n\r\n// \u6545\u969c\u8f6c\u79fb\u7387\r\nfailoverRate := prometheus.NewGaugeVec(\r\n    prometheus.GaugeOpts{\r\n        Name: "rpc_failover_rate",\r\n        Help: "Rate of failovers per service",\r\n    },\r\n    []string{"service"},\r\n)\n'})}),"\n",(0,s.jsx)(r.h3,{id:"\u4f7f\u7528prometheusmetrics",children:"\u4f7f\u7528PrometheusMetrics"}),"\n",(0,s.jsx)(r.p,{children:"\u5c06Prometheus\u6307\u6807\u6536\u96c6\u5668\u4e0efyerrpc\u7ec4\u4ef6\u96c6\u6210\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// \u4e0e\u8d1f\u8f7d\u5747\u8861\u5668\u96c6\u6210\r\nlb, err := balancer.Build(&balancer.Config{\r\n    Type:           balancer.FastestResponse,\r\n    MetricsClient:  metricsClient,\r\n    UpdateInterval: 30,\r\n    RetryTimes:     3,\r\n})\r\n\r\n// \u4e0e\u6545\u969c\u8f6c\u79fb\u5904\u7406\u5668\u96c6\u6210\r\nhandler, err := failover.NewFailoverHandler(&failover.Config{\r\n    MaxRetries:      3,\r\n    RetryInterval:   time.Millisecond * 100,\r\n    EnableMetrics:   true,\r\n    FailoverStrategy: "next",\r\n})\r\n\r\n// \u8bb0\u5f55RPC\u8c03\u7528\u6307\u6807\r\nmetricsClient.RecordResponse(ctx, &metrics.ResponseMetric{\r\n    ServiceName: "user-service",\r\n    MethodName:  "GetUser",\r\n    Instance:    "10.0.0.1:8080",\r\n    Duration:    time.Millisecond * 50,\r\n    Status:      "success",\r\n    Timestamp:   time.Now(),\r\n})\n'})}),"\n",(0,s.jsx)(r.h3,{id:"\u67e5\u8be2\u6307\u6807\u6570\u636e",children:"\u67e5\u8be2\u6307\u6807\u6570\u636e"}),"\n",(0,s.jsx)(r.p,{children:"\u4f7f\u7528PrometheusMetrics\u67e5\u8be2\u6027\u80fd\u6307\u6807\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// \u83b7\u53d6\u6307\u5b9a\u670d\u52a1\u5b9e\u4f8b\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\r\nlatency, err := metricsClient.GetLatency(ctx, "user-service", "10.0.0.1:8080")\r\nif err != nil {\r\n    log.Printf("Failed to get latency: %v", err)\r\n} else {\r\n    log.Printf("Average latency: %v", latency)\r\n}\r\n\r\n// \u83b7\u53d6\u670d\u52a1\u6240\u6709\u5b9e\u4f8b\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\r\nlatencyMap, err := metricsClient.GetServiceLatency(ctx, "user-service")\r\nif err != nil {\r\n    log.Printf("Failed to get service latencies: %v", err)\r\n} else {\r\n    for instance, latency := range latencyMap {\r\n        log.Printf("Instance %s average latency: %v", instance, latency)\r\n    }\r\n}\r\n\r\n// \u83b7\u53d6\u6545\u969c\u8f6c\u79fb\u7387\r\nrate, err := metricsClient.GetFailoverRate(ctx, "user-service")\r\nif err != nil {\r\n    log.Printf("Failed to get failover rate: %v", err)\r\n} else {\r\n    log.Printf("Failover rate: %.2f%%", rate*100)\r\n}\n'})}),"\n",(0,s.jsx)(r.h2,{id:"\u76d1\u63a7\u914d\u7f6e",children:"\u76d1\u63a7\u914d\u7f6e"}),"\n",(0,s.jsx)(r.h3,{id:"\u5ba2\u6237\u7aef\u76d1\u63a7\u914d\u7f6e",children:"\u5ba2\u6237\u7aef\u76d1\u63a7\u914d\u7f6e"}),"\n",(0,s.jsx)(r.p,{children:"\u5728\u5ba2\u6237\u7aef\u914d\u7f6e\u4e2d\u542f\u7528\u76d1\u63a7\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// \u521b\u5efa\u5ba2\u6237\u7aef\u914d\u7f6e\r\nconfig := config.NewClientConfig(\r\n    // \u5176\u4ed6\u914d\u7f6e...\r\n    \r\n    // \u914d\u7f6e\u6307\u6807\u6536\u96c6\u548c\u76d1\u63a7\r\n    config.WithMetrics(true, metricsClient),\r\n    config.WithMonitoringInterval(time.Second * 5),\r\n)\r\n\r\n// \u521b\u5efa\u5ba2\u6237\u7aef\r\nclient, err := api.NewClient(&api.ClientOptions{\r\n    Address:       "localhost:8000",\r\n    Metrics:       metricsClient,\r\n    EnableMetrics: true,\r\n})\n'})}),"\n",(0,s.jsx)(r.h3,{id:"\u670d\u52a1\u7aef\u76d1\u63a7\u914d\u7f6e",children:"\u670d\u52a1\u7aef\u76d1\u63a7\u914d\u7f6e"}),"\n",(0,s.jsx)(r.p,{children:"\u5728\u670d\u52a1\u7aef\u914d\u7f6e\u4e2d\u542f\u7528\u76d1\u63a7\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// \u521b\u5efa\u670d\u52a1\u5668\u914d\u7f6e\r\noptions := &api.ServerOptions{\r\n    Address:        ":8000",\r\n    EnableRegistry: true,\r\n    Registry:       registry,\r\n    ServiceName:    "greeter-service",\r\n    ServiceVersion: "1.0.0",\r\n    \r\n    // \u76d1\u63a7\u914d\u7f6e\r\n    Metrics:        metricsClient,\r\n    EnableMetrics:  true,\r\n    MetricsPath:    "/metrics",  // \u66b4\u9732Prometheus\u6307\u6807\u7684HTTP\u8def\u5f84\r\n}\r\n\r\n// \u521b\u5efa\u670d\u52a1\u5668\r\nserver := api.NewServer(options)\n'})}),"\n",(0,s.jsx)(r.h2,{id:"\u96c6\u6210prometheus\u76d1\u63a7\u6808",children:"\u96c6\u6210Prometheus\u76d1\u63a7\u6808"}),"\n",(0,s.jsx)(r.p,{children:"fyerrpc\u53ef\u4ee5\u4e0e\u5b8c\u6574\u7684Prometheus\u76d1\u63a7\u6808\u96c6\u6210\uff0c\u5305\u62ecGrafana\u3001AlertManager\u7b49\uff1a"}),"\n",(0,s.jsx)(r.h3,{id:"prometheus\u914d\u7f6e",children:"Prometheus\u914d\u7f6e"}),"\n",(0,s.jsx)(r.p,{children:"\u5728Prometheus\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0fyerrpc\u670d\u52a1\u7684\u6293\u53d6\u914d\u7f6e\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"scrape_configs:\r\n  - job_name: 'fyerrpc'\r\n    scrape_interval: 5s\r\n    static_configs:\r\n      - targets: ['localhost:8080']\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u5982\u679c\u4f7f\u7528\u63a8\u9001\u7f51\u5173\uff0c\u5219\u914d\u7f6e\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"scrape_configs:\r\n  - job_name: 'pushgateway'\r\n    scrape_interval: 5s\r\n    static_configs:\r\n      - targets: ['localhost:9091']\r\n    honor_labels: true\n"})}),"\n",(0,s.jsx)(r.h3,{id:"grafana\u4eea\u8868\u677f",children:"Grafana\u4eea\u8868\u677f"}),"\n",(0,s.jsx)(r.p,{children:"\u5bf9\u4e8eGrafana\uff0cfyerrpc\u56e2\u961f\u63d0\u4f9b\u4e86\u9884\u5b9a\u4e49\u7684\u4eea\u8868\u677f\u6a21\u677f\uff0c\u53ef\u4ee5\u76f4\u63a5\u5bfc\u5165\u5230\u60a8\u7684Grafana\u5b9e\u4f8b\u4e2d\u3002\u4eea\u8868\u677f\u5305\u62ec\u4ee5\u4e0b\u56fe\u8868\uff1a"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"RPC\u54cd\u5e94\u65f6\u95f4\u5206\u5e03\u56fe"}),"\n",(0,s.jsx)(r.li,{children:"\u8bf7\u6c42\u6210\u529f\u7387\u89c6\u56fe"}),"\n",(0,s.jsx)(r.li,{children:"\u6bcf\u670d\u52a1\u5b9e\u4f8b\u8bf7\u6c42\u91cf"}),"\n",(0,s.jsx)(r.li,{children:"\u6545\u969c\u8f6c\u79fb\u7387\u548c\u4e8b\u4ef6"}),"\n",(0,s.jsx)(r.li,{children:"\u7194\u65ad\u5668\u72b6\u6001\u53d8\u5316"}),"\n",(0,s.jsx)(r.li,{children:"\u91cd\u8bd5\u5206\u5e03"}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"\u81ea\u5b9a\u4e49\u6307\u6807\u6536\u96c6\u5668",children:"\u81ea\u5b9a\u4e49\u6307\u6807\u6536\u96c6\u5668"}),"\n",(0,s.jsxs)(r.p,{children:["\u60a8\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0",(0,s.jsx)(r.code,{children:"metrics.Metrics"}),"\u63a5\u53e3\u521b\u5efa\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u6536\u96c6\u5668\uff1a"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// \u81ea\u5b9a\u4e49\u6307\u6807\u6536\u96c6\u5668\u5b9e\u73b0\r\ntype MyCustomMetrics struct {\r\n    // \u60a8\u7684\u6307\u6807\u6536\u96c6\u5668\u5b57\u6bb5\r\n}\r\n\r\n// RecordResponse \u8bb0\u5f55\u54cd\u5e94\u65f6\u95f4\r\nfunc (m *MyCustomMetrics) RecordResponse(ctx context.Context, metric *metrics.ResponseMetric) error {\r\n    // \u5b9e\u73b0\u54cd\u5e94\u65f6\u95f4\u8bb0\u5f55\u903b\u8f91\r\n    return nil\r\n}\r\n\r\n// GetLatency \u83b7\u53d6\u6307\u5b9a\u670d\u52a1\u5b9e\u4f8b\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\r\nfunc (m *MyCustomMetrics) GetLatency(ctx context.Context, service, instance string) (time.Duration, error) {\r\n    // \u5b9e\u73b0\u83b7\u53d6\u5ef6\u8fdf\u65f6\u95f4\u7684\u903b\u8f91\r\n    return time.Millisecond * 100, nil\r\n}\r\n\r\n// \u5b9e\u73b0\u5176\u4ed6\u63a5\u53e3\u65b9\u6cd5...\r\n\r\n// \u4f7f\u7528\u81ea\u5b9a\u4e49\u6307\u6807\u6536\u96c6\u5668\r\nmyMetrics := &MyCustomMetrics{}\r\nclient, err := api.NewClient(&api.ClientOptions{\r\n    Address: "localhost:8000",\r\n    Metrics: myMetrics,\r\n})\n'})}),"\n",(0,s.jsx)(r.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsx)(r.h3,{id:"\u9009\u62e9\u5408\u9002\u7684\u6307\u6807\u6536\u96c6\u65b9\u5f0f",children:"\u9009\u62e9\u5408\u9002\u7684\u6307\u6807\u6536\u96c6\u65b9\u5f0f"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u5f00\u53d1\u548c\u6d4b\u8bd5\u73af\u5883"}),"\uff1a\u4f7f\u7528\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668\u6216",(0,s.jsx)(r.code,{children:"NoopMetrics"}),"\u4ee5\u63d0\u9ad8\u6027\u80fd"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u751f\u4ea7\u73af\u5883"}),"\uff1a\u96c6\u6210Prometheus\u4ee5\u83b7\u5f97\u5168\u9762\u7684\u76d1\u63a7\u80fd\u529b\u548c\u5386\u53f2\u6570\u636e\u5206\u6790"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"\u4f18\u5316\u6307\u6807\u6536\u96c6",children:"\u4f18\u5316\u6307\u6807\u6536\u96c6"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u5408\u7406\u8bbe\u7f6e\u91c7\u6837\u7387"}),"\uff1a\u5bf9\u4e8e\u9ad8\u6d41\u91cf\u670d\u52a1\uff0c\u53ef\u4ee5\u8003\u8651\u53ea\u8bb0\u5f55\u4e00\u90e8\u5206\u8bf7\u6c42\u7684\u8be6\u7ec6\u6307\u6807"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u4f18\u5316\u63a8\u9001\u95f4\u9694"}),"\uff1a\u6839\u636e\u670d\u52a1\u8d1f\u8f7d\u548c\u76d1\u63a7\u9700\u6c42\u8c03\u6574Prometheus\u6307\u6807\u63a8\u9001\u9891\u7387"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u5206\u5c42\u76d1\u63a7"}),"\uff1a\u5173\u952e\u670d\u52a1\u4f7f\u7528\u66f4\u9ad8\u9891\u7387\u7684\u76d1\u63a7\uff0c\u975e\u5173\u952e\u670d\u52a1\u53ef\u4ee5\u964d\u4f4e\u76d1\u63a7\u9891\u7387"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"\u544a\u8b66\u914d\u7f6e",children:"\u544a\u8b66\u914d\u7f6e"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u8bbe\u7f6e\u5173\u952e\u6307\u6807\u544a\u8b66"}),"\uff1a\u914d\u7f6e\u9519\u8bef\u7387\u3001\u54cd\u5e94\u65f6\u95f4\u548c\u6545\u969c\u8f6c\u79fb\u7387\u7684\u544a\u8b66\u9608\u503c"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u5206\u7ea7\u544a\u8b66"}),"\uff1a\u6839\u636e\u6307\u6807\u4e25\u91cd\u7a0b\u5ea6\u914d\u7f6e\u4e0d\u540c\u7ea7\u522b\u7684\u544a\u8b66\u901a\u77e5"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u9884\u8bbe\u544a\u8b66\u6a21\u677f"}),"\uff1a\u4e3a\u5e38\u89c1\u95ee\u9898\u51c6\u5907\u6807\u51c6\u7684\u544a\u8b66\u6a21\u677f\u548c\u5904\u7406\u6d41\u7a0b"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"\u6269\u5c55\u76d1\u63a7\u8303\u56f4",children:"\u6269\u5c55\u76d1\u63a7\u8303\u56f4"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u96c6\u6210\u94fe\u8def\u8ffd\u8e2a"}),"\uff1a\u4e0eOpenTelemetry\u6216Jaeger\u7b49\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u96c6\u6210"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u65e5\u5fd7\u5173\u8054"}),"\uff1a\u5c06\u76d1\u63a7\u6307\u6807\u4e0e\u65e5\u5fd7\u7cfb\u7edf\u5173\u8054\uff0c\u4fbf\u4e8e\u95ee\u9898\u5b9a\u4f4d"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\u4e1a\u52a1\u6307\u6807"}),"\uff1a\u9664\u4e86\u6280\u672f\u6307\u6807\u5916\uff0c\u8fd8\u53ef\u4ee5\u76d1\u63a7\u5173\u952e\u4e1a\u52a1\u6307\u6807"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"\u793a\u4f8b\u5b8c\u6574\u76d1\u63a7\u914d\u7f6e",children:"\u793a\u4f8b\uff1a\u5b8c\u6574\u76d1\u63a7\u914d\u7f6e"}),"\n",(0,s.jsx)(r.p,{children:"\u4e0b\u9762\u662f\u4e00\u4e2a\u96c6\u6210Prometheus\u7684\u5b8c\u6574\u76d1\u63a7\u914d\u7f6e\u793a\u4f8b\uff1a"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n\t"context"\r\n\t"log"\r\n\t"time"\r\n\r\n\t"github.com/fyerfyer/fyer-rpc/api"\r\n\t"github.com/fyerfyer/fyer-rpc/discovery/metrics"\r\n)\r\n\r\nfunc main() {\r\n\t// \u521b\u5efaPrometheus\u6307\u6807\u6536\u96c6\u5668\r\n\tmetricsClient, err := metrics.NewPrometheusMetrics(&metrics.PrometheusConfig{\r\n\t\tPushGatewayURL: "http://prometheus-pushgateway:9091",\r\n\t\tQueryURL:       "http://prometheus:9090",\r\n\t\tJobName:        "fyerrpc-user-service",\r\n\t\tPushInterval:   time.Second * 5,\r\n\t})\r\n\tif err != nil {\r\n\t\tlog.Fatalf("Failed to create metrics client: %v", err)\r\n\t}\r\n\tdefer metricsClient.Close()\r\n\r\n\t// \u521b\u5efa\u670d\u52a1\u5668\u914d\u7f6e\r\n\toptions := &api.ServerOptions{\r\n\t\tAddress:       ":8080",\r\n\t\tServiceName:   "user-service",\r\n\t\tServiceVersion: "1.0.0",\r\n\t\t\r\n\t\t// \u76d1\u63a7\u914d\u7f6e\r\n\t\tMetrics:       metricsClient,\r\n\t\tEnableMetrics: true,\r\n\t\tMetricsPath:   "/metrics",\r\n\t}\r\n\r\n\t// \u521b\u5efa\u670d\u52a1\u5668\r\n\tserver := api.NewServer(options)\r\n\r\n\t// \u6ce8\u518c\u670d\u52a1\r\n\tserver.Register(&UserService{})\r\n\r\n\t// \u542f\u52a8\u670d\u52a1\u5668\r\n\tif err := server.Start(); err != nil {\r\n\t\tlog.Fatalf("Failed to start server: %v", err)\r\n\t}\r\n\r\n\t// \u7b49\u5f85\u4fe1\u53f7\u505c\u6b62\u670d\u52a1\u5668\r\n\t// ...\r\n}\n'})})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>c,x:()=>l});var t=n(6540);const s={},i=t.createContext(s);function c(e){const r=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),t.createElement(i.Provider,{value:r},e.children)}}}]);