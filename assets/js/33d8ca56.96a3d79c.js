"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[992],{2448:(r,n,e)=>{e.r(n),e.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>d,frontMatter:()=>s,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"advanced/cluster/cluster","title":"Cluster","description":"\u96c6\u7fa4\u7ba1\u7406\u662ffyerrpc\u6846\u67b6\u4e2d\u7684\u9ad8\u7ea7\u529f\u80fd\uff0c\u6839\u636e\u4e0d\u540c\u6761\u4ef6\u548c\u7b56\u7565\u7ba1\u7406\u548c\u8def\u7531\u670d\u52a1\u8bf7\u6c42\u3002","source":"@site/docs/advanced/cluster/cluster.md","sourceDirName":"advanced/cluster","slug":"/advanced/cluster/","permalink":"/fyer-rpc/docs/advanced/cluster/","draft":false,"unlisted":false,"editUrl":"https://github.com/fyerfyer/fyer-rpc/tree/main/docs/advanced/cluster/cluster.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","next":{"title":"Failover","permalink":"/fyer-rpc/docs/advanced/failover/"}}');var c=e(4848),a=e(8453);const s={},i="Cluster",o={},l=[{value:"\u5206\u7ec4\u7ba1\u7406 (Group)",id:"\u5206\u7ec4\u7ba1\u7406-group",level:2},{value:"\u57fa\u7840\u6982\u5ff5",id:"\u57fa\u7840\u6982\u5ff5",level:3},{value:"Group \u63a5\u53e3",id:"group-\u63a5\u53e3",level:4},{value:"\u5206\u7ec4\u914d\u7f6e",id:"\u5206\u7ec4\u914d\u7f6e",level:4},{value:"\u5339\u914d\u89c4\u5219",id:"\u5339\u914d\u89c4\u5219",level:4},{value:"\u521b\u5efa\u4e0e\u4f7f\u7528\u5206\u7ec4",id:"\u521b\u5efa\u4e0e\u4f7f\u7528\u5206\u7ec4",level:3},{value:"\u521b\u5efa\u5206\u7ec4",id:"\u521b\u5efa\u5206\u7ec4",level:4},{value:"\u5206\u7ec4\u5339\u914d",id:"\u5206\u7ec4\u5339\u914d",level:4},{value:"\u5206\u7ec4\u9009\u62e9",id:"\u5206\u7ec4\u9009\u62e9",level:4},{value:"A/B\u6d4b\u8bd5\u5206\u7ec4",id:"ab\u6d4b\u8bd5\u5206\u7ec4",level:3},{value:"\u8def\u7531\u89c4\u5219 (Router)",id:"\u8def\u7531\u89c4\u5219-router",level:2},{value:"\u8def\u7531\u63a5\u53e3",id:"\u8def\u7531\u63a5\u53e3",level:3},{value:"\u4f7f\u7528\u5185\u7f6e\u8def\u7531\u5668",id:"\u4f7f\u7528\u5185\u7f6e\u8def\u7531\u5668",level:3},{value:"\u6807\u7b7e\u8def\u7531\u5668",id:"\u6807\u7b7e\u8def\u7531\u5668",level:4},{value:"\u6743\u91cd\u8def\u7531\u5668",id:"\u6743\u91cd\u8def\u7531\u5668",level:4},{value:"\u7248\u672c\u8def\u7531\u5668",id:"\u7248\u672c\u8def\u7531\u5668",level:4},{value:"\u8def\u7531\u94fe",id:"\u8def\u7531\u94fe",level:3},{value:"\u57fa\u4e8e\u4e0a\u4e0b\u6587\u7684\u8def\u7531",id:"\u57fa\u4e8e\u4e0a\u4e0b\u6587\u7684\u8def\u7531",level:3},{value:"\u9009\u62e9\u5668 (Selector)",id:"\u9009\u62e9\u5668-selector",level:2},{value:"\u9009\u62e9\u5668\u63a5\u53e3",id:"\u9009\u62e9\u5668\u63a5\u53e3",level:3},{value:"\u9009\u62e9\u5668\u914d\u7f6e",id:"\u9009\u62e9\u5668\u914d\u7f6e",level:3},{value:"\u4f7f\u7528\u5185\u7f6e\u9009\u62e9\u5668",id:"\u4f7f\u7528\u5185\u7f6e\u9009\u62e9\u5668",level:3},{value:"\u5206\u7ec4\u9009\u62e9\u5668",id:"\u5206\u7ec4\u9009\u62e9\u5668",level:4},{value:"\u57fa\u7840\u9009\u62e9\u5668",id:"\u57fa\u7840\u9009\u62e9\u5668",level:4},{value:"\u9009\u62e9\u5668\u94fe",id:"\u9009\u62e9\u5668\u94fe",level:3},{value:"\u96c6\u6210\u793a\u4f8b",id:"\u96c6\u6210\u793a\u4f8b",level:2},{value:"\u9ad8\u7ea7\u4f7f\u7528\u573a\u666f",id:"\u9ad8\u7ea7\u4f7f\u7528\u573a\u666f",level:2},{value:"\u7070\u5ea6\u53d1\u5e03",id:"\u7070\u5ea6\u53d1\u5e03",level:3},{value:"\u533a\u57df\u611f\u77e5\u8def\u7531",id:"\u533a\u57df\u611f\u77e5\u8def\u7531",level:3},{value:"\u81ea\u5b9a\u4e49\u9009\u62e9\u7b56\u7565",id:"\u81ea\u5b9a\u4e49\u9009\u62e9\u7b56\u7565",level:3}];function u(r){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",...(0,a.R)(),...r.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"cluster",children:"Cluster"})}),"\n",(0,c.jsx)(n.p,{children:"\u96c6\u7fa4\u7ba1\u7406\u662ffyerrpc\u6846\u67b6\u4e2d\u7684\u9ad8\u7ea7\u529f\u80fd\uff0c\u6839\u636e\u4e0d\u540c\u6761\u4ef6\u548c\u7b56\u7565\u7ba1\u7406\u548c\u8def\u7531\u670d\u52a1\u8bf7\u6c42\u3002"}),"\n",(0,c.jsx)(n.h2,{id:"\u5206\u7ec4\u7ba1\u7406-group",children:"\u5206\u7ec4\u7ba1\u7406 (Group)"}),"\n",(0,c.jsx)(n.p,{children:"\u5206\u7ec4\u7ba1\u7406\u5c06\u670d\u52a1\u5b9e\u4f8b\u5212\u5206\u4e3a\u4e0d\u540c\u7684\u903b\u8f91\u7ec4\uff0c\u4fbf\u4e8e\u8fdb\u884c\u7070\u5ea6\u53d1\u5e03\u3001A/B\u6d4b\u8bd5\u548c\u670d\u52a1\u9694\u79bb\u7b49\u573a\u666f\u3002"}),"\n",(0,c.jsx)(n.h3,{id:"\u57fa\u7840\u6982\u5ff5",children:"\u57fa\u7840\u6982\u5ff5"}),"\n",(0,c.jsx)(n.h4,{id:"group-\u63a5\u53e3",children:"Group \u63a5\u53e3"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Group"})," \u63a5\u53e3\u5b9a\u4e49\u4e86\u670d\u52a1\u5206\u7ec4\u7684\u57fa\u672c\u884c\u4e3a\uff1a"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type Group interface {\r\n    // Name \u8fd4\u56de\u5206\u7ec4\u540d\u79f0\r\n    Name() string\r\n\r\n    // Match \u68c0\u67e5\u5b9e\u4f8b\u662f\u5426\u5339\u914d\u8be5\u5206\u7ec4\r\n    Match(instance *naming.Instance) bool\r\n\r\n    // Select \u4ece\u5b9e\u4f8b\u5217\u8868\u4e2d\u9009\u62e9\u5339\u914d\u8be5\u5206\u7ec4\u7684\u5b9e\u4f8b\r\n    Select(ctx context.Context, instances []*naming.Instance) ([]*naming.Instance, error)\r\n}\n"})}),"\n",(0,c.jsx)(n.h4,{id:"\u5206\u7ec4\u914d\u7f6e",children:"\u5206\u7ec4\u914d\u7f6e"}),"\n",(0,c.jsx)(n.p,{children:"\u5206\u7ec4\u901a\u8fc7 Config \u7ed3\u6784\u8fdb\u884c\u914d\u7f6e\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'type Config struct {\r\n    // Name \u5206\u7ec4\u540d\u79f0\r\n    Name string `json:"name"`\r\n\r\n    // Type \u5206\u7ec4\u7c7b\u578b\uff0c\u5982A/B\u6d4b\u8bd5\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\r\n    Type string `json:"type"`\r\n\r\n    // Matcher \u5206\u7ec4\u5339\u914d\u89c4\u5219\r\n    Matcher *MatchConfig `json:"matcher"`\r\n\r\n    // Weight \u5206\u7ec4\u6743\u91cd(0-100)\r\n    Weight int `json:"weight"`\r\n\r\n    // EnableHealthCheck \u662f\u5426\u542f\u7528\u5065\u5eb7\u68c0\u67e5\r\n    EnableHealthCheck bool `json:"enable_health_check"`\r\n\r\n    // HealthCheckInterval \u5065\u5eb7\u68c0\u67e5\u95f4\u9694\r\n    HealthCheckInterval time.Duration `json:"health_check_interval"`\r\n\r\n    // Metadata \u5206\u7ec4\u5143\u6570\u636e\r\n    Metadata map[string]string `json:"metadata"`\r\n}\n'})}),"\n",(0,c.jsx)(n.h4,{id:"\u5339\u914d\u89c4\u5219",children:"\u5339\u914d\u89c4\u5219"}),"\n",(0,c.jsxs)(n.p,{children:["fyerrpc\u652f\u6301\u591a\u79cd\u5339\u914d\u89c4\u5219\uff0c\u901a\u8fc7 ",(0,c.jsx)(n.code,{children:"MatchConfig"})," \u7ed3\u6784\u914d\u7f6e\uff1a"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'type MatchConfig struct {\r\n    // MatchType \u5339\u914d\u7c7b\u578b\uff1aexact(\u7cbe\u786e\u5339\u914d)\u3001prefix(\u524d\u7f00\u5339\u914d)\u3001regex(\u6b63\u5219\u5339\u914d)\r\n    MatchType string `json:"match_type"`\r\n\r\n    // MatchKey \u5339\u914d\u7684\u952e\uff0c\u5982\u73af\u5883\u53d8\u91cf\u540d\u3001Header\u540d\u7b49\r\n    MatchKey string `json:"match_key"`\r\n\r\n    // MatchValue \u5339\u914d\u7684\u503c\r\n    MatchValue string `json:"match_value"`\r\n\r\n    // Labels \u6807\u7b7e\u5339\u914d\u89c4\u5219\r\n    Labels map[string]string `json:"labels"`\r\n}\n'})}),"\n",(0,c.jsx)(n.h3,{id:"\u521b\u5efa\u4e0e\u4f7f\u7528\u5206\u7ec4",children:"\u521b\u5efa\u4e0e\u4f7f\u7528\u5206\u7ec4"}),"\n",(0,c.jsx)(n.h4,{id:"\u521b\u5efa\u5206\u7ec4",children:"\u521b\u5efa\u5206\u7ec4"}),"\n",(0,c.jsxs)(n.p,{children:["\u4f7f\u7528 ",(0,c.jsx)(n.code,{children:"NewGroup"})," \u51fd\u6570\u521b\u5efa\u5206\u7ec4\uff1a"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u57fa\u4e8e\u7cbe\u786e\u5339\u914d\u7684\u5206\u7ec4\r\ngroup, err := group.NewGroup("prod-group",\r\n    group.WithMatcher(&group.MatchConfig{\r\n        MatchType:  "exact",\r\n        MatchKey:   "env",\r\n        MatchValue: "production",\r\n    }),\r\n    group.WithWeight(80),\r\n)\r\nif err != nil {\r\n    log.Fatalf("Failed to create group: %v", err)\r\n}\r\n\r\n// \u521b\u5efa\u57fa\u4e8e\u6b63\u5219\u5339\u914d\u7684\u5206\u7ec4\r\ncanaryGroup, err := group.NewGroup("canary-group",\r\n    group.WithMatcher(&group.MatchConfig{\r\n        MatchType:  "regex",\r\n        MatchKey:   "version",\r\n        MatchValue: "^2\\\\..*$", // \u5339\u914d\u6240\u67092.x\u7248\u672c\r\n    }),\r\n    group.WithWeight(20),\r\n)\n'})}),"\n",(0,c.jsx)(n.h4,{id:"\u5206\u7ec4\u5339\u914d",children:"\u5206\u7ec4\u5339\u914d"}),"\n",(0,c.jsx)(n.p,{children:"\u4f7f\u7528\u5206\u7ec4\u5bf9\u5b9e\u4f8b\u8fdb\u884c\u5339\u914d\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u6d4b\u8bd5\u5b9e\u4f8b\r\ninstance := &naming.Instance{\r\n    ID:      "instance-1",\r\n    Service: "my-service",\r\n    Address: "localhost:8080",\r\n    Metadata: map[string]string{\r\n        "env": "production",\r\n    },\r\n}\r\n\r\n// \u68c0\u67e5\u5b9e\u4f8b\u662f\u5426\u5339\u914d\u5206\u7ec4\r\nif group.Match(instance) {\r\n    fmt.Println("Instance matches production group")\r\n}\n'})}),"\n",(0,c.jsx)(n.h4,{id:"\u5206\u7ec4\u9009\u62e9",children:"\u5206\u7ec4\u9009\u62e9"}),"\n",(0,c.jsx)(n.p,{children:"\u4ece\u5b9e\u4f8b\u5217\u8868\u4e2d\u9009\u62e9\u5339\u914d\u5206\u7ec4\u7684\u5b9e\u4f8b\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u591a\u4e2a\u5b9e\u4f8b\r\ninstances := []*naming.Instance{\r\n    {\r\n        ID:      "instance-1",\r\n        Service: "my-service",\r\n        Address: "localhost:8081",\r\n        Metadata: map[string]string{\r\n            "env": "production",\r\n        },\r\n    },\r\n    {\r\n        ID:      "instance-2",\r\n        Service: "my-service",\r\n        Address: "localhost:8082",\r\n        Metadata: map[string]string{\r\n            "env": "testing",\r\n        },\r\n    },\r\n}\r\n\r\n// \u9009\u62e9\u5339\u914d\u7684\u5b9e\u4f8b\r\nselected, err := group.Select(context.Background(), instances)\r\nif err != nil {\r\n    log.Fatalf("Group selection failed: %v", err)\r\n}\r\n\r\nfmt.Printf("Selected %d instances\\n", len(selected))\r\nfor _, inst := range selected {\r\n    fmt.Printf("  - %s (%s)\\n", inst.ID, inst.Address)\r\n}\n'})}),"\n",(0,c.jsx)(n.h3,{id:"ab\u6d4b\u8bd5\u5206\u7ec4",children:"A/B\u6d4b\u8bd5\u5206\u7ec4"}),"\n",(0,c.jsx)(n.p,{children:"fyerrpc\u63d0\u4f9b\u4e86\u4e13\u95e8\u7684A/B\u6d4b\u8bd5\u5206\u7ec4\u5b9e\u73b0\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efaA/B\u6d4b\u8bd5\u5206\u7ec4\u9009\u62e9\u5668\r\nabSelector := group.NewABGroupSelector(\r\n    "ab-test",       // \u9009\u62e9\u5668\u540d\u79f0\r\n    "version-a",     // A\u7ec4\u540d\u79f0\r\n    "version-b",     // B\u7ec4\u540d\u79f0\r\n    0.8,             // A\u7ec4\u6d41\u91cf\u6bd4\u4f8b(80%)\r\n)\r\n\r\n// \u4f7f\u7528\u9009\u62e9\u5668\u9009\u62e9\u5b9e\u4f8b\r\nctx := context.Background()\r\nselected, err := abSelector.Select(ctx, instances)\n'})}),"\n",(0,c.jsx)(n.p,{children:"\u60a8\u8fd8\u53ef\u4ee5\u5728\u4e0a\u4e0b\u6587\u4e2d\u6307\u5b9a\u5f3a\u5236\u5206\u7ec4\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u5f3a\u5236\u4f7f\u7528A\u7ec4\r\nctx := context.WithValue(context.Background(), "ab_group", "version-a")\r\nselected, err := abSelector.Select(ctx, instances)\n'})}),"\n",(0,c.jsx)(n.h2,{id:"\u8def\u7531\u89c4\u5219-router",children:"\u8def\u7531\u89c4\u5219 (Router)"}),"\n",(0,c.jsx)(n.p,{children:"\u8def\u7531\u89c4\u5219\u5141\u8bb8\u60a8\u6839\u636e\u8bf7\u6c42\u4e0a\u4e0b\u6587\u4fe1\u606f\u52a8\u6001\u9009\u62e9\u670d\u52a1\u5b9e\u4f8b\uff0c\u5b9e\u73b0\u8bf7\u6c42\u7ea7\u522b\u7684\u6d41\u91cf\u63a7\u5236\u3002"}),"\n",(0,c.jsx)(n.h3,{id:"\u8def\u7531\u63a5\u53e3",children:"\u8def\u7531\u63a5\u53e3"}),"\n",(0,c.jsxs)(n.p,{children:["\u8def\u7531\u901a\u8fc7 ",(0,c.jsx)(n.code,{children:"GroupRouter"})," \u63a5\u53e3\u5b9e\u73b0\uff1a"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type GroupRouter interface {\r\n    // Route \u6839\u636e\u4e0a\u4e0b\u6587\u8def\u7531\u5230\u6307\u5b9a\u5206\u7ec4\r\n    Route(ctx context.Context, instances []*naming.Instance) ([]*naming.Instance, error)\r\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"\u4f7f\u7528\u5185\u7f6e\u8def\u7531\u5668",children:"\u4f7f\u7528\u5185\u7f6e\u8def\u7531\u5668"}),"\n",(0,c.jsx)(n.p,{children:"fyerrpc\u63d0\u4f9b\u4e86\u591a\u79cd\u5185\u7f6e\u8def\u7531\u5668\u5b9e\u73b0\uff1a"}),"\n",(0,c.jsx)(n.h4,{id:"\u6807\u7b7e\u8def\u7531\u5668",children:"\u6807\u7b7e\u8def\u7531\u5668"}),"\n",(0,c.jsx)(n.p,{children:"\u57fa\u4e8e\u5143\u6570\u636e\u6807\u7b7e\u7684\u8def\u7531\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u57fa\u4e8e\u6807\u7b7e\u7684\u8def\u7531\u5668\r\ntagRouter := group.NewTagRouter("env", "production")\r\n\r\n// \u8def\u7531\u5b9e\u4f8b\r\ninstances := getServiceInstances() // \u83b7\u53d6\u670d\u52a1\u5b9e\u4f8b\u5217\u8868\r\nrouted, err := tagRouter.Route(context.Background(), instances)\r\nif err != nil {\r\n    log.Fatalf("Routing failed: %v", err)\r\n}\n'})}),"\n",(0,c.jsx)(n.h4,{id:"\u6743\u91cd\u8def\u7531\u5668",children:"\u6743\u91cd\u8def\u7531\u5668"}),"\n",(0,c.jsx)(n.p,{children:"\u57fa\u4e8e\u6743\u91cd\u7684\u8def\u7531\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u57fa\u4e8e\u6743\u91cd\u7684\u8def\u7531\u5668\uff0c\u53ea\u9009\u62e9\u6743\u91cd>=80\u7684\u5b9e\u4f8b\r\nweightRouter := group.NewWeightRouter("weight", 80)\r\n\r\n// \u8def\u7531\u5b9e\u4f8b\r\nrouted, err := weightRouter.Route(context.Background(), instances)\n'})}),"\n",(0,c.jsx)(n.h4,{id:"\u7248\u672c\u8def\u7531\u5668",children:"\u7248\u672c\u8def\u7531\u5668"}),"\n",(0,c.jsx)(n.p,{children:"\u57fa\u4e8e\u670d\u52a1\u7248\u672c\u7684\u8def\u7531\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u57fa\u4e8e\u7248\u672c\u7684\u8def\u7531\u5668\r\nversionRouter := group.NewVersionRouter("1.0.0")\r\n\r\n// \u8def\u7531\u5b9e\u4f8b\r\nrouted, err := versionRouter.Route(context.Background(), instances)\n'})}),"\n",(0,c.jsx)(n.h3,{id:"\u8def\u7531\u94fe",children:"\u8def\u7531\u94fe"}),"\n",(0,c.jsx)(n.p,{children:"fyerrpc\u652f\u6301\u8def\u7531\u94fe\uff0c\u5c06\u591a\u4e2a\u8def\u7531\u89c4\u5219\u7ec4\u5408\u4f7f\u7528\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u8def\u7531\u94fe\r\nchain := group.NewRouterChain(\r\n    group.NewTagRouter("env", "production"),     // \u5148\u6309\u73af\u5883\u8def\u7531\r\n    group.NewWeightRouter("weight", 80),         // \u518d\u6309\u6743\u91cd\u8def\u7531\r\n    group.NewVersionRouter("1.0.0"),             // \u6700\u540e\u6309\u7248\u672c\u8def\u7531\r\n)\r\n\r\n// \u6267\u884c\u8def\u7531\u94fe\r\nrouted, err := chain.Route(context.Background(), instances)\n'})}),"\n",(0,c.jsx)(n.p,{children:"\u8def\u7531\u94fe\u4f1a\u4f9d\u6b21\u6267\u884c\u6bcf\u4e2a\u8def\u7531\u89c4\u5219\uff0c\u524d\u4e00\u4e2a\u8def\u7531\u7684\u7ed3\u679c\u5c06\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u8def\u7531\u7684\u8f93\u5165\u3002\u5982\u679c\u4efb\u4f55\u4e00\u4e2a\u8def\u7531\u89c4\u5219\u8fd4\u56de\u7a7a\u7ed3\u679c\u6216\u9519\u8bef\uff0c\u6574\u4e2a\u8def\u7531\u94fe\u5c06\u5931\u8d25\u3002"}),"\n",(0,c.jsx)(n.h3,{id:"\u57fa\u4e8e\u4e0a\u4e0b\u6587\u7684\u8def\u7531",children:"\u57fa\u4e8e\u4e0a\u4e0b\u6587\u7684\u8def\u7531"}),"\n",(0,c.jsx)(n.p,{children:"\u53ef\u4ee5\u901a\u8fc7\u4e0a\u4e0b\u6587\u4f20\u9012\u8def\u7531\u4fe1\u606f\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u8bbe\u7f6e\u4e0a\u4e0b\u6587\u4e2d\u7684\u5206\u7ec4\u4fe1\u606f\r\nctx := group.WithGroup(context.Background(), group.GroupKey("production"))\r\n\r\n// \u521b\u5efa\u8def\u7531\u5668\r\nrouter := group.NewRouter(groupManager)\r\n\r\n// \u6839\u636e\u4e0a\u4e0b\u6587\u8def\u7531\r\nrouted, err := router.Route(ctx, instances)\n'})}),"\n",(0,c.jsx)(n.h2,{id:"\u9009\u62e9\u5668-selector",children:"\u9009\u62e9\u5668 (Selector)"}),"\n",(0,c.jsx)(n.p,{children:"\u9009\u62e9\u5668\u8d1f\u8d23\u4ece\u4e00\u7ec4\u670d\u52a1\u5b9e\u4f8b\u4e2d\u6839\u636e\u7279\u5b9a\u7b56\u7565\u9009\u62e9\u5408\u9002\u7684\u5b9e\u4f8b\u5b50\u96c6\uff0c\u5e38\u7528\u4e8e\u670d\u52a1\u53d1\u73b0\u548c\u8d1f\u8f7d\u5747\u8861\u573a\u666f\u3002"}),"\n",(0,c.jsx)(n.h3,{id:"\u9009\u62e9\u5668\u63a5\u53e3",children:"\u9009\u62e9\u5668\u63a5\u53e3"}),"\n",(0,c.jsxs)(n.p,{children:["\u9009\u62e9\u5668\u901a\u8fc7 ",(0,c.jsx)(n.code,{children:"Selector"})," \u63a5\u53e3\u5b9e\u73b0\uff1a"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type Selector interface {\r\n    // Select \u4ece\u670d\u52a1\u5b9e\u4f8b\u5217\u8868\u4e2d\u9009\u62e9\u7b26\u5408\u6761\u4ef6\u7684\u5b9e\u4f8b\r\n    Select(ctx context.Context, instances []*naming.Instance) ([]*naming.Instance, error)\r\n    \r\n    // Name \u8fd4\u56de\u9009\u62e9\u5668\u540d\u79f0\r\n    Name() string\r\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"\u9009\u62e9\u5668\u914d\u7f6e",children:"\u9009\u62e9\u5668\u914d\u7f6e"}),"\n",(0,c.jsx)(n.p,{children:"\u9009\u62e9\u5668\u901a\u8fc7 Config \u7ed3\u6784\u8fdb\u884c\u914d\u7f6e\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'type Config struct {\r\n    // Strategy \u9009\u62e9\u7b56\u7565\uff0c\u5982group\u3001version\u3001region\u7b49\r\n    Strategy string `json:"strategy"`\r\n\r\n    // Filter \u7b5b\u9009\u89c4\u5219\r\n    Filter map[string]string `json:"filter"`\r\n\r\n    // Priority \u9009\u62e9\u5668\u4f18\u5148\u7ea7\uff0c\u6570\u5b57\u8d8a\u5c0f\u4f18\u5148\u7ea7\u8d8a\u9ad8\r\n    Priority int `json:"priority"`\r\n\r\n    // Required \u662f\u5426\u5fc5\u987b\u6ee1\u8db3\u9009\u62e9\u6761\u4ef6\r\n    Required bool `json:"required"`\r\n\r\n    // Metadata \u989d\u5916\u7684\u5143\u6570\u636e\r\n    Metadata map[string]string `json:"metadata"`\r\n}\n'})}),"\n",(0,c.jsx)(n.h3,{id:"\u4f7f\u7528\u5185\u7f6e\u9009\u62e9\u5668",children:"\u4f7f\u7528\u5185\u7f6e\u9009\u62e9\u5668"}),"\n",(0,c.jsx)(n.p,{children:"fyerrpc\u63d0\u4f9b\u4e86\u591a\u79cd\u5185\u7f6e\u9009\u62e9\u5668\u5b9e\u73b0\uff1a"}),"\n",(0,c.jsx)(n.h4,{id:"\u5206\u7ec4\u9009\u62e9\u5668",children:"\u5206\u7ec4\u9009\u62e9\u5668"}),"\n",(0,c.jsx)(n.p,{children:"\u57fa\u4e8e\u5206\u7ec4\u4fe1\u606f\u9009\u62e9\u5b9e\u4f8b\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u5206\u7ec4\u9009\u62e9\u5668\r\ngroupSelector := selector.NewGroupSelector(\r\n    "group-selector", // \u9009\u62e9\u5668\u540d\u79f0\r\n    "group",          // \u5206\u7ec4\u5143\u6570\u636e\u952e\r\n    "production",     // \u9ed8\u8ba4\u5206\u7ec4\u540d\r\n)\r\n\r\n// \u4f7f\u7528\u9009\u62e9\u5668\r\nselected, err := groupSelector.Select(context.Background(), instances)\r\nif err != nil {\r\n    log.Fatalf("Selection failed: %v", err)\r\n}\n'})}),"\n",(0,c.jsx)(n.p,{children:"\u53ef\u4ee5\u901a\u8fc7\u4e0a\u4e0b\u6587\u6307\u5b9a\u5206\u7ec4\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u6307\u5b9a\u4f7f\u7528testing\u5206\u7ec4\r\nctx := selector.WithGroup(context.Background(), "group", "testing")\r\nselected, err := groupSelector.Select(ctx, instances)\n'})}),"\n",(0,c.jsx)(n.h4,{id:"\u57fa\u7840\u9009\u62e9\u5668",children:"\u57fa\u7840\u9009\u62e9\u5668"}),"\n",(0,c.jsx)(n.p,{children:"\u4f7f\u7528\u81ea\u5b9a\u4e49\u9009\u62e9\u51fd\u6570\u521b\u5efa\u9009\u62e9\u5668\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u57fa\u7840\u9009\u62e9\u5668\uff0c\u9009\u62e9\u524d\u4e09\u4e2a\u5b9e\u4f8b\r\nbaseSelector := selector.NewBaseSelector("top3", func(ctx context.Context, instances []*naming.Instance) ([]*naming.Instance, error) {\r\n    if len(instances) <= 3 {\r\n        return instances, nil\r\n    }\r\n    return instances[:3], nil\r\n})\r\n\r\n// \u4f7f\u7528\u9009\u62e9\u5668\r\nselected, err := baseSelector.Select(context.Background(), instances)\n'})}),"\n",(0,c.jsx)(n.h3,{id:"\u9009\u62e9\u5668\u94fe",children:"\u9009\u62e9\u5668\u94fe"}),"\n",(0,c.jsx)(n.p,{children:"\u9009\u62e9\u5668\u94fe\u5141\u8bb8\u7ec4\u5408\u591a\u4e2a\u9009\u62e9\u5668\uff0c\u66f4\u7cbe\u7ec6\u5730\u63a7\u5236\u5b9e\u4f8b\u9009\u62e9\u8fc7\u7a0b\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u9009\u62e9\u5668\u94fe\r\nchain := selector.NewChain("my-chain",\r\n    groupSelector,                // \u5148\u6309\u5206\u7ec4\u9009\u62e9\r\n    regionSelector,               // \u518d\u6309\u533a\u57df\u9009\u62e9\r\n    healthSelector,               // \u6700\u540e\u53ea\u4fdd\u7559\u5065\u5eb7\u5b9e\u4f8b\r\n)\r\n\r\n// \u4f7f\u7528\u9009\u62e9\u5668\u94fe\r\nselected, err := chain.Select(context.Background(), instances)\n'})}),"\n",(0,c.jsx)(n.p,{children:"\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6784\u5efa\u5668\u6a21\u5f0f\u521b\u5efa\u9009\u62e9\u5668\u94fe\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"// \u4f7f\u7528\u6784\u5efa\u5668\u521b\u5efa\u9009\u62e9\u5668\u94fe\r\nchain := selector.NewChainBuilder().\r\n    Add(groupSelector).\r\n    Add(regionSelector).\r\n    Add(healthSelector).\r\n    Build()\r\n\r\n// \u4f7f\u7528\u9009\u62e9\u5668\u94fe\r\nselected, err := chain.Select(context.Background(), instances)\n"})}),"\n",(0,c.jsx)(n.h2,{id:"\u96c6\u6210\u793a\u4f8b",children:"\u96c6\u6210\u793a\u4f8b"}),"\n",(0,c.jsx)(n.p,{children:"\u4ee5\u4e0b\u662f\u4e00\u4e2a\u7efc\u5408\u793a\u4f8b\uff0c\u5c55\u793a\u5982\u4f55\u7ed3\u5408\u5206\u7ec4\u3001\u8def\u7531\u548c\u9009\u62e9\u5668\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n    "context"\r\n    "fmt"\r\n    "log"\r\n\r\n    "github.com/fyerfyer/fyer-rpc/cluster/group"\r\n    "github.com/fyerfyer/fyer-rpc/cluster/selector"\r\n    "github.com/fyerfyer/fyer-rpc/naming"\r\n)\r\n\r\nfunc main() {\r\n    // \u521b\u5efa\u670d\u52a1\u5b9e\u4f8b\r\n    instances := []*naming.Instance{\r\n        {\r\n            ID:      "instance-1",\r\n            Service: "user-service",\r\n            Version: "1.0.0",\r\n            Address: "10.0.1.1:8080",\r\n            Metadata: map[string]string{\r\n                "env":    "production",\r\n                "region": "us-east",\r\n                "weight": "100",\r\n                "group":  "stable",\r\n            },\r\n        },\r\n        {\r\n            ID:      "instance-2",\r\n            Service: "user-service",\r\n            Version: "1.1.0",\r\n            Address: "10.0.1.2:8080",\r\n            Metadata: map[string]string{\r\n                "env":    "production",\r\n                "region": "us-east",\r\n                "weight": "80",\r\n                "group":  "canary",\r\n            },\r\n        },\r\n        {\r\n            ID:      "instance-3",\r\n            Service: "user-service",\r\n            Version: "1.0.0",\r\n            Address: "10.0.2.1:8080",\r\n            Metadata: map[string]string{\r\n                "env":    "production",\r\n                "region": "us-west",\r\n                "weight": "100",\r\n                "group":  "stable",\r\n            },\r\n        },\r\n    }\r\n\r\n    // 1. \u521b\u5efa\u5206\u7ec4\r\n    stableGroup, err := group.NewGroup("stable",\r\n        group.WithMatcher(&group.MatchConfig{\r\n            MatchType:  "exact",\r\n            MatchKey:   "group",\r\n            MatchValue: "stable",\r\n        }),\r\n        group.WithWeight(90),\r\n    )\r\n    if err != nil {\r\n        log.Fatalf("Failed to create stable group: %v", err)\r\n    }\r\n\r\n    canaryGroup, err := group.NewGroup("canary",\r\n        group.WithMatcher(&group.MatchConfig{\r\n            MatchType:  "exact",\r\n            MatchKey:   "group",\r\n            MatchValue: "canary",\r\n        }),\r\n        group.WithWeight(10),\r\n    )\r\n    if err != nil {\r\n        log.Fatalf("Failed to create canary group: %v", err)\r\n    }\r\n\r\n    // 2. \u521b\u5efa\u5206\u7ec4\u7ba1\u7406\u5668 (\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u5b9e\u73b0)\r\n    groupManager := &SimpleGroupManager{\r\n        groups: map[string]group.Group{\r\n            "stable": stableGroup,\r\n            "canary": canaryGroup,\r\n        },\r\n    }\r\n\r\n    // 3. \u521b\u5efa\u8def\u7531\u5668\r\n    router := group.NewRouter(groupManager)\r\n\r\n    // 4. \u521b\u5efa\u533a\u57df\u9009\u62e9\u5668\r\n    regionSelector := selector.NewBaseSelector("region-selector", func(ctx context.Context, insts []*naming.Instance) ([]*naming.Instance, error) {\r\n        region, ok := ctx.Value("region").(string)\r\n        if !ok {\r\n            return insts, nil\r\n        }\r\n\r\n        var selected []*naming.Instance\r\n        for _, inst := range insts {\r\n            if r, ok := inst.Metadata["region"]; ok && r == region {\r\n                selected = append(selected, inst)\r\n            }\r\n        }\r\n        \r\n        if len(selected) == 0 {\r\n            return insts, nil // \u5982\u679c\u6ca1\u6709\u5339\u914d\u7684\u5b9e\u4f8b\uff0c\u8fd4\u56de\u6240\u6709\u5b9e\u4f8b\r\n        }\r\n        return selected, nil\r\n    })\r\n\r\n    // 5. \u521b\u5efa\u9009\u62e9\u5668\u94fe\r\n    selectorChain := selector.NewChain("region-group-chain", regionSelector)\r\n\r\n    // 6. \u7528\u6237\u8bf7\u6c42\u573a\u666f\u6a21\u62df\r\n    \r\n    // \u573a\u666f1: \u7a33\u5b9a\u7248\u7528\u6237\uff0c\u4e1c\u533a\r\n    fmt.Println("Scenario 1: Stable user in East region")\r\n    ctx1 := context.Background()\r\n    ctx1 = group.WithGroup(ctx1, group.GroupKey("stable"))\r\n    ctx1 = context.WithValue(ctx1, "region", "us-east")\r\n    \r\n    // \u5148\u8def\u7531\u5230\u5206\u7ec4\r\n    groupInstances, err := router.Route(ctx1, instances)\r\n    if err != nil {\r\n        log.Printf("Routing error: %v", err)\r\n    } else {\r\n        // \u518d\u6309\u533a\u57df\u9009\u62e9\r\n        selected, err := selectorChain.Select(ctx1, groupInstances)\r\n        if err != nil {\r\n            log.Printf("Selection error: %v", err)\r\n        } else {\r\n            fmt.Printf("Selected %d instances:\\n", len(selected))\r\n            for _, inst := range selected {\r\n                fmt.Printf("  - %s (%s) [%s, %s]\\n", \r\n                    inst.ID, inst.Address, \r\n                    inst.Metadata["group"], inst.Metadata["region"])\r\n            }\r\n        }\r\n    }\r\n    \r\n    // \u573a\u666f2: \u7070\u5ea6\u7528\u6237\r\n    fmt.Println("\\nScenario 2: Canary user")\r\n    ctx2 := group.WithGroup(context.Background(), group.GroupKey("canary"))\r\n    \r\n    groupInstances, err = router.Route(ctx2, instances)\r\n    if err != nil {\r\n        log.Printf("Routing error: %v", err)\r\n    } else {\r\n        fmt.Printf("Selected %d instances:\\n", len(groupInstances))\r\n        for _, inst := range groupInstances {\r\n            fmt.Printf("  - %s (%s) [%s]\\n", \r\n                inst.ID, inst.Address, inst.Metadata["group"])\r\n        }\r\n    }\r\n}\r\n\r\n// \u7b80\u5355\u5206\u7ec4\u7ba1\u7406\u5668\u5b9e\u73b0\r\ntype SimpleGroupManager struct {\r\n    groups map[string]group.Group\r\n}\r\n\r\nfunc (m *SimpleGroupManager) RegisterGroup(g group.Group) error {\r\n    m.groups[g.Name()] = g\r\n    return nil\r\n}\r\n\r\nfunc (m *SimpleGroupManager) GetGroup(name string) (group.Group, error) {\r\n    if g, ok := m.groups[name]; ok {\r\n        return g, nil\r\n    }\r\n    return nil, fmt.Errorf("group not found: %s", name)\r\n}\r\n\r\nfunc (m *SimpleGroupManager) ListGroups() []group.Group {\r\n    groups := make([]group.Group, 0, len(m.groups))\r\n    for _, g := range m.groups {\r\n        groups = append(groups, g)\r\n    }\r\n    return groups\r\n}\n'})}),"\n",(0,c.jsx)(n.h2,{id:"\u9ad8\u7ea7\u4f7f\u7528\u573a\u666f",children:"\u9ad8\u7ea7\u4f7f\u7528\u573a\u666f"}),"\n",(0,c.jsx)(n.h3,{id:"\u7070\u5ea6\u53d1\u5e03",children:"\u7070\u5ea6\u53d1\u5e03"}),"\n",(0,c.jsx)(n.p,{children:"\u4f7f\u7528\u5206\u7ec4\u548c\u6743\u91cd\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u7a33\u5b9a\u7248\u548c\u7070\u5ea6\u7248\u5206\u7ec4\r\nstableGroup, _ := group.NewGroup("stable", \r\n    group.WithMatcher(&group.MatchConfig{\r\n        MatchType:  "exact",\r\n        MatchKey:   "version",\r\n        MatchValue: "1.0.0",\r\n    }),\r\n    group.WithWeight(90),\r\n)\r\n\r\ncanaryGroup, _ := group.NewGroup("canary", \r\n    group.WithMatcher(&group.MatchConfig{\r\n        MatchType:  "exact",\r\n        MatchKey:   "version",\r\n        MatchValue: "1.1.0",\r\n    }),\r\n    group.WithWeight(10),\r\n)\r\n\r\n// \u521b\u5efaA/B\u9009\u62e9\u5668\u8fdb\u884c\u6d41\u91cf\u5206\u914d\r\nabSelector := group.NewABGroupSelector("version-test", "stable", "canary", 0.9)\n'})}),"\n",(0,c.jsx)(n.h3,{id:"\u533a\u57df\u611f\u77e5\u8def\u7531",children:"\u533a\u57df\u611f\u77e5\u8def\u7531"}),"\n",(0,c.jsx)(n.p,{children:"\u6839\u636e\u7528\u6237\u533a\u57df\u9009\u62e9\u5c31\u8fd1\u670d\u52a1\u5b9e\u4f8b\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u533a\u57df\u8def\u7531\u5668\r\nregionRouter := group.NewTagRouter("region", "us-east")\r\n\r\n// \u521b\u5efa\u53ef\u7528\u533a\u8def\u7531\u5668\r\nzoneRouter := group.NewTagRouter("zone", "us-east-1a")\r\n\r\n// \u521b\u5efa\u8def\u7531\u94fe\uff0c\u4f18\u5148\u9009\u62e9\u540c\u53ef\u7528\u533a\uff0c\u5176\u6b21\u540c\u533a\u57df\r\nchain := group.NewRouterChain(\r\n    zoneRouter,  // \u5148\u5c1d\u8bd5\u540c\u53ef\u7528\u533a\r\n    regionRouter, // \u82e5\u65e0\u53ef\u7528\u5b9e\u4f8b\uff0c\u5219\u9009\u62e9\u540c\u533a\u57df\r\n)\n'})}),"\n",(0,c.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49\u9009\u62e9\u7b56\u7565",children:"\u81ea\u5b9a\u4e49\u9009\u62e9\u7b56\u7565"}),"\n",(0,c.jsx)(n.p,{children:"\u5b9e\u73b0\u81ea\u5b9a\u4e49\u9009\u62e9\u5668\u4ee5\u6ee1\u8db3\u7279\u6b8a\u9700\u6c42\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u6309CPU\u4f7f\u7528\u7387\u9009\u62e9\u7684\u9009\u62e9\u5668\r\ncpuSelector := selector.NewBaseSelector("cpu-usage", func(ctx context.Context, instances []*naming.Instance) ([]*naming.Instance, error) {\r\n    // \u6309CPU\u4f7f\u7528\u7387\u6392\u5e8f\r\n    sort.Slice(instances, func(i, j int) bool {\r\n        cpuI, _ := strconv.ParseFloat(instances[i].Metadata["cpu_usage"], 64)\r\n        cpuJ, _ := strconv.ParseFloat(instances[j].Metadata["cpu_usage"], 64)\r\n        return cpuI < cpuJ // \u9009\u62e9CPU\u4f7f\u7528\u7387\u4f4e\u7684\u5b9e\u4f8b\r\n    })\r\n    \r\n    // \u8fd4\u56deCPU\u4f7f\u7528\u7387\u6700\u4f4e\u76843\u4e2a\u5b9e\u4f8b\r\n    if len(instances) > 3 {\r\n        return instances[:3], nil\r\n    }\r\n    return instances, nil\r\n})\n'})})]})}function d(r={}){const{wrapper:n}={...(0,a.R)(),...r.components};return n?(0,c.jsx)(n,{...r,children:(0,c.jsx)(u,{...r})}):u(r)}},8453:(r,n,e)=>{e.d(n,{R:()=>s,x:()=>i});var t=e(6540);const c={},a=t.createContext(c);function s(r){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof r?r(n):{...n,...r}}),[n,r])}function i(r){let n;return n=r.disableParentContext?"function"==typeof r.components?r.components(c):r.components||c:s(r.components),t.createElement(a.Provider,{value:n},r.children)}}}]);