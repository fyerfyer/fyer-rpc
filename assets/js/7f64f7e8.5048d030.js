"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[36],{8324:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>s,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"advanced/failover/failover","title":"Failover","description":"\u6545\u969c\u8f6c\u79fb\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u91cd\u8981\u7684\u5bb9\u9519\u673a\u5236\uff0c\u5f53\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53d1\u751f\u6545\u969c\u6216\u4e0d\u53ef\u7528\u65f6\uff0c\u53ef\u4ee5\u81ea\u52a8\u5207\u6362\u5230\u5176\u4ed6\u53ef\u7528\u5b9e\u4f8b\uff0c\u4ece\u800c\u4fdd\u8bc1\u7cfb\u7edf\u7684\u9ad8\u53ef\u7528\u6027\u3002","source":"@site/docs/advanced/failover/failover.md","sourceDirName":"advanced/failover","slug":"/advanced/failover/","permalink":"/fyer-rpc/docs/advanced/failover/","draft":false,"unlisted":false,"editUrl":"https://github.com/fyerfyer/fyer-rpc/tree/main/docs/advanced/failover/failover.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Cluster","permalink":"/fyer-rpc/docs/advanced/cluster/"},"next":{"title":"Load Balance","permalink":"/fyer-rpc/docs/advanced/load-balancer/"}}');var i=r(4848),l=r(8453);const c={},s="Failover",a={},o=[{value:"\u6545\u969c\u8f6c\u79fb\u57fa\u7840",id:"\u6545\u969c\u8f6c\u79fb\u57fa\u7840",level:2},{value:"\u6545\u969c\u8f6c\u79fb\u6d41\u7a0b",id:"\u6545\u969c\u8f6c\u79fb\u6d41\u7a0b",level:3},{value:"\u6838\u5fc3\u7ec4\u4ef6",id:"\u6838\u5fc3\u7ec4\u4ef6",level:2},{value:"FailoverHandler \u63a5\u53e3",id:"failoverhandler-\u63a5\u53e3",level:3},{value:"\u6545\u969c\u8f6c\u79fb\u914d\u7f6e",id:"\u6545\u969c\u8f6c\u79fb\u914d\u7f6e",level:3},{value:"\u6545\u969c\u68c0\u6d4b",id:"\u6545\u969c\u68c0\u6d4b",level:2},{value:"Detector \u63a5\u53e3",id:"detector-\u63a5\u53e3",level:3},{value:"\u5b9e\u4f8b\u72b6\u6001",id:"\u5b9e\u4f8b\u72b6\u6001",level:3},{value:"\u68c0\u6d4b\u5668\u5b9e\u73b0",id:"\u68c0\u6d4b\u5668\u5b9e\u73b0",level:3},{value:"\u7194\u65ad\u5668",id:"\u7194\u65ad\u5668",level:2},{value:"CircuitBreaker \u63a5\u53e3",id:"circuitbreaker-\u63a5\u53e3",level:3},{value:"\u7194\u65ad\u5668\u72b6\u6001",id:"\u7194\u65ad\u5668\u72b6\u6001",level:3},{value:"\u7194\u65ad\u5668\u5b9e\u73b0",id:"\u7194\u65ad\u5668\u5b9e\u73b0",level:3},{value:"\u91cd\u8bd5\u7b56\u7565",id:"\u91cd\u8bd5\u7b56\u7565",level:2},{value:"RetryPolicy \u63a5\u53e3",id:"retrypolicy-\u63a5\u53e3",level:3},{value:"\u91cd\u8bd5\u7b56\u7565\u5b9e\u73b0",id:"\u91cd\u8bd5\u7b56\u7565\u5b9e\u73b0",level:3},{value:"\u6062\u590d\u7b56\u7565",id:"\u6062\u590d\u7b56\u7565",level:2},{value:"RecoveryStrategy \u63a5\u53e3",id:"recoverystrategy-\u63a5\u53e3",level:3},{value:"\u6062\u590d\u7b56\u7565\u5b9e\u73b0",id:"\u6062\u590d\u7b56\u7565\u5b9e\u73b0",level:3},{value:"\u4f7f\u7528\u6545\u969c\u8f6c\u79fb",id:"\u4f7f\u7528\u6545\u969c\u8f6c\u79fb",level:2},{value:"\u521b\u5efa\u6545\u969c\u8f6c\u79fb\u5904\u7406\u5668",id:"\u521b\u5efa\u6545\u969c\u8f6c\u79fb\u5904\u7406\u5668",level:3},{value:"\u6267\u884c\u5e26\u6545\u969c\u8f6c\u79fb\u7684\u8c03\u7528",id:"\u6267\u884c\u5e26\u6545\u969c\u8f6c\u79fb\u7684\u8c03\u7528",level:3},{value:"\u6545\u969c\u8f6c\u79fb\u7ed3\u679c",id:"\u6545\u969c\u8f6c\u79fb\u7ed3\u679c",level:3},{value:"\u6307\u6807\u6536\u96c6\u4e0e\u76d1\u63a7",id:"\u6307\u6807\u6536\u96c6\u4e0e\u76d1\u63a7",level:2},{value:"\u6307\u6807\u6536\u96c6\u63a5\u53e3",id:"\u6307\u6807\u6536\u96c6\u63a5\u53e3",level:3},{value:"\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668",id:"\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"failover",children:"Failover"})}),"\n",(0,i.jsx)(n.p,{children:"\u6545\u969c\u8f6c\u79fb\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u91cd\u8981\u7684\u5bb9\u9519\u673a\u5236\uff0c\u5f53\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53d1\u751f\u6545\u969c\u6216\u4e0d\u53ef\u7528\u65f6\uff0c\u53ef\u4ee5\u81ea\u52a8\u5207\u6362\u5230\u5176\u4ed6\u53ef\u7528\u5b9e\u4f8b\uff0c\u4ece\u800c\u4fdd\u8bc1\u7cfb\u7edf\u7684\u9ad8\u53ef\u7528\u6027\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"\u6545\u969c\u8f6c\u79fb\u57fa\u7840",children:"\u6545\u969c\u8f6c\u79fb\u57fa\u7840"}),"\n",(0,i.jsx)(n.p,{children:"fyerrpc\u7684\u6545\u969c\u8f6c\u79fb\u7cfb\u7edf\u5305\u542b\u5982\u4e0b\u7684\u529f\u80fd\u8bbe\u8ba1\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5feb\u901f\u63a2\u6d4b"}),"\uff1a\u5feb\u901f\u51c6\u786e\u5730\u68c0\u6d4b\u670d\u52a1\u5b9e\u4f8b\u6545\u969c"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u52a8\u6001\u6062\u590d"}),"\uff1a\u5728\u670d\u52a1\u6062\u590d\u540e\u80fd\u591f\u81ea\u52a8\u5c06\u5176\u91cd\u65b0\u7eb3\u5165\u53ef\u7528\u5b9e\u4f8b\u6c60"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u7075\u6d3b\u7b56\u7565"}),"\uff1a\u63d0\u4f9b\u591a\u79cd\u6545\u969c\u8f6c\u79fb\u7b56\u7565\uff0c\u9002\u5e94\u4e0d\u540c\u573a\u666f\u9700\u6c42"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u7194\u65ad\u4fdd\u62a4"}),"\uff1a\u7ed3\u5408\u7194\u65ad\u5668\u6a21\u5f0f\u907f\u514d\u6301\u7eed\u8c03\u7528\u4e0d\u53ef\u7528\u5b9e\u4f8b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u667a\u80fd\u91cd\u8bd5"}),"\uff1a\u9488\u5bf9\u4e0d\u540c\u7c7b\u578b\u7684\u9519\u8bef\u91c7\u7528\u5408\u9002\u7684\u91cd\u8bd5\u7b56\u7565"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u6545\u969c\u8f6c\u79fb\u6d41\u7a0b",children:"\u6545\u969c\u8f6c\u79fb\u6d41\u7a0b"}),"\n",(0,i.jsx)(n.p,{children:"fyerrpc\u7684\u6545\u969c\u8f6c\u79fb\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6545\u969c\u68c0\u6d4b"}),"\uff1a\u68c0\u6d4b\u670d\u52a1\u5b9e\u4f8b\u662f\u5426\u5065\u5eb7\u53ef\u7528"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u7194\u65ad\u4fdd\u62a4"}),"\uff1a\u5bf9\u9891\u7e41\u51fa\u9519\u7684\u5b9e\u4f8b\u8fdb\u884c\u7194\u65ad"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5b9e\u4f8b\u9009\u62e9"}),"\uff1a\u6839\u636e\u7b56\u7565\u9009\u62e9\u53ef\u7528\u5b9e\u4f8b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u8c03\u7528\u6267\u884c"}),"\uff1a\u6267\u884c\u8fdc\u7a0b\u8c03\u7528\u64cd\u4f5c"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u7ed3\u679c\u5904\u7406"}),"\uff1a\u6839\u636e\u8c03\u7528\u7ed3\u679c\u8fdb\u884c\u72b6\u6001\u66f4\u65b0\u548c\u6307\u6807\u6536\u96c6"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6545\u969c\u6062\u590d"}),"\uff1a\u5b9a\u671f\u68c0\u6d4b\u5e76\u6062\u590d\u4e0d\u5065\u5eb7\u5b9e\u4f8b"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u6838\u5fc3\u7ec4\u4ef6",children:"\u6838\u5fc3\u7ec4\u4ef6"}),"\n",(0,i.jsx)(n.h3,{id:"failoverhandler-\u63a5\u53e3",children:"FailoverHandler \u63a5\u53e3"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"FailoverHandler"}),"\u662f\u6545\u969c\u8f6c\u79fb\u529f\u80fd\u7684\u6838\u5fc3\u63a5\u53e3\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type FailoverHandler interface {\r\n    // Execute \u6267\u884c\u5e26\u6545\u969c\u8f6c\u79fb\u7684\u8c03\u7528\r\n    Execute(ctx context.Context, instances []*naming.Instance, operation func(context.Context, *naming.Instance) error) (*FailoverResult, error)\r\n\r\n    // GetDetector \u83b7\u53d6\u6545\u969c\u68c0\u6d4b\u5668\r\n    GetDetector() Detector\r\n\r\n    // GetCircuitBreaker \u83b7\u53d6\u7194\u65ad\u5668\r\n    GetCircuitBreaker() CircuitBreaker\r\n\r\n    // GetRetryPolicy \u83b7\u53d6\u91cd\u8bd5\u7b56\u7565\r\n    GetRetryPolicy() RetryPolicy\r\n\r\n    // GetRecoveryStrategy \u83b7\u53d6\u6062\u590d\u7b56\u7565\r\n    GetRecoveryStrategy() RecoveryStrategy\r\n\r\n    // GetMonitor \u83b7\u53d6\u5b9e\u4f8b\u76d1\u63a7\u5668\r\n    GetMonitor() InstanceMonitor\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u6545\u969c\u8f6c\u79fb\u914d\u7f6e",children:"\u6545\u969c\u8f6c\u79fb\u914d\u7f6e"}),"\n",(0,i.jsx)(n.p,{children:"\u6545\u969c\u8f6c\u79fb\u529f\u80fd\u901a\u8fc7Config\u7ed3\u6784\u8fdb\u884c\u914d\u7f6e\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Config struct {\r\n    // \u91cd\u8bd5\u76f8\u5173\u914d\u7f6e\r\n    MaxRetries      int           // \u6700\u5927\u91cd\u8bd5\u6b21\u6570\r\n    RetryInterval   time.Duration // \u91cd\u8bd5\u95f4\u9694\u57fa\u51c6\u65f6\u95f4\r\n    RetryableErrors []string      // \u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u7c7b\u578b\u5217\u8868\r\n    RetryStrategy   string        // \u91cd\u8bd5\u7b56\u7565: simple, exponential, jittered\r\n\r\n    // \u7194\u65ad\u76f8\u5173\u914d\u7f6e\r\n    CircuitBreakThreshold    int           // \u7194\u65ad\u9608\u503c\uff0c\u8fde\u7eed\u5931\u8d25\u6b21\u6570\r\n    CircuitBreakTimeout      time.Duration // \u7194\u65ad\u8d85\u65f6\u65f6\u95f4\r\n    \r\n    // \u6545\u969c\u68c0\u6d4b\u914d\u7f6e\r\n    FailureDetectionTime time.Duration // \u6545\u969c\u68c0\u6d4b\u65f6\u95f4\u7a97\u53e3\r\n    FailureThreshold     int           // \u6545\u969c\u9608\u503c\u6b21\u6570\r\n    SuccessThreshold     int           // \u6210\u529f\u9608\u503c\u6b21\u6570\r\n    \r\n    // \u6062\u590d\u7b56\u7565\u914d\u7f6e\r\n    RecoveryStrategy  string        // \u6062\u590d\u7b56\u7565\uff1aimmediate, gradual, probing\r\n    \r\n    // \u901a\u7528\u914d\u7f6e\r\n    FailoverStrategy string // \u6545\u969c\u8f6c\u79fb\u7b56\u7565\uff1anext, random, best\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u4f7f\u7528\u51fd\u6570\u9009\u9879\u6a21\u5f0f\u8fdb\u884c\u914d\u7f6e\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'config := failover.NewConfig(\r\n    failover.WithMaxRetries(3),\r\n    failover.WithRetryInterval(100*time.Millisecond),\r\n    failover.WithRetryBackoff(1.5, time.Second),\r\n    failover.WithRetryJitter(0.2),\r\n    failover.WithRetryableErrors([]string{"connection refused", "timeout"}),\r\n    failover.WithCircuitBreaker(5, 30*time.Second),\r\n    failover.WithFailoverStrategy("next"),\r\n)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u6545\u969c\u68c0\u6d4b",children:"\u6545\u969c\u68c0\u6d4b"}),"\n",(0,i.jsx)(n.p,{children:"\u6545\u969c\u68c0\u6d4b\u8d1f\u8d23\u5224\u65ad\u670d\u52a1\u5b9e\u4f8b\u662f\u5426\u5065\u5eb7\uff0c\u662f\u6545\u969c\u8f6c\u79fb\u7684\u57fa\u7840\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"detector-\u63a5\u53e3",children:"Detector \u63a5\u53e3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Detector interface {\r\n    // Detect \u68c0\u6d4b\u5b9e\u4f8b\u662f\u5426\u5065\u5eb7\r\n    Detect(ctx context.Context, instance *naming.Instance) (Status, error)\r\n\r\n    // MarkFailed \u6807\u8bb0\u5b9e\u4f8b\u4e3a\u5931\u8d25\u72b6\u6001\r\n    MarkFailed(ctx context.Context, instance *naming.Instance) error\r\n\r\n    // MarkSuccess \u6807\u8bb0\u5b9e\u4f8b\u4e3a\u6210\u529f\u72b6\u6001\r\n    MarkSuccess(ctx context.Context, instance *naming.Instance) error\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u5b9e\u4f8b\u72b6\u6001",children:"\u5b9e\u4f8b\u72b6\u6001"}),"\n",(0,i.jsx)(n.p,{children:"\u670d\u52a1\u5b9e\u4f8b\u53ef\u80fd\u5904\u4e8e\u4ee5\u4e0b\u72b6\u6001\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Status int\r\n\r\nconst (\r\n    StatusHealthy   Status = iota // \u5065\u5eb7\u72b6\u6001\r\n    StatusUnhealthy               // \u4e0d\u5065\u5eb7\u72b6\u6001\r\n    StatusSuspect                 // \u53ef\u7591\u72b6\u6001\uff0c\u53ef\u80fd\u4e0d\u5065\u5eb7\r\n    StatusIsolated                // \u88ab\u9694\u79bb\u72b6\u6001\r\n)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u68c0\u6d4b\u5668\u5b9e\u73b0",children:"\u68c0\u6d4b\u5668\u5b9e\u73b0"}),"\n",(0,i.jsx)(n.p,{children:"fyerrpc\u63d0\u4f9b\u4e86\u591a\u79cd\u6545\u969c\u68c0\u6d4b\u5668\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"TimeoutDetector"}),"\uff1a\u57fa\u4e8e\u8fde\u63a5\u8d85\u65f6\u7684\u68c0\u6d4b\u5668\uff0c\u901a\u8fc7\u5c1d\u8bd5TCP\u8fde\u63a5\u6765\u5224\u65ad\u5b9e\u4f8b\u5065\u5eb7\u72b6\u6001"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u57fa\u4e8e\u8d85\u65f6\u7684\u6545\u969c\u68c0\u6d4b\u5668\r\ndetector := failover.NewTimeoutDetector(config)\r\n\r\n// \u68c0\u6d4b\u5b9e\u4f8b\u72b6\u6001\r\nstatus, err := detector.Detect(ctx, instance)\r\nif err != nil || status != failover.StatusHealthy {\r\n    log.Printf("Instance %s is not healthy: %v", instance.Address, err)\r\n}\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"ErrorRateDetector"}),"\uff1a\u57fa\u4e8e\u9519\u8bef\u7387\u7684\u68c0\u6d4b\u5668\uff0c\u8bb0\u5f55\u8c03\u7528\u9519\u8bef\u7387\u5224\u65ad\u5b9e\u4f8b\u5065\u5eb7\u72b6\u6001"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"HealthCheckDetector"}),"\uff1a\u901a\u8fc7\u5b9a\u671f\u5065\u5eb7\u68c0\u67e5\u5224\u65ad\u5b9e\u4f8b\u72b6\u6001"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u7194\u65ad\u5668",children:"\u7194\u65ad\u5668"}),"\n",(0,i.jsx)(n.p,{children:"\u7194\u65ad\u5668\u6a21\u5f0f\u9632\u6b62\u6301\u7eed\u8c03\u7528\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u5b9e\u4f8b\uff0c\u63d0\u9ad8\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"circuitbreaker-\u63a5\u53e3",children:"CircuitBreaker \u63a5\u53e3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type CircuitBreaker interface {\r\n    // Allow \u5224\u65ad\u8bf7\u6c42\u662f\u5426\u5141\u8bb8\u901a\u8fc7\r\n    Allow(ctx context.Context, instance *naming.Instance) (bool, error)\r\n\r\n    // MarkSuccess \u6807\u8bb0\u6210\u529f\u8c03\u7528\r\n    MarkSuccess(ctx context.Context, instance *naming.Instance) error\r\n\r\n    // MarkFailure \u6807\u8bb0\u5931\u8d25\u8c03\u7528\r\n    MarkFailure(ctx context.Context, instance *naming.Instance, err error) error\r\n\r\n    // GetState \u83b7\u53d6\u7194\u65ad\u5668\u72b6\u6001\r\n    GetState(instance *naming.Instance) (State, error)\r\n\r\n    // Reset \u91cd\u7f6e\u7194\u65ad\u5668\u72b6\u6001\r\n    Reset(instance *naming.Instance) error\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u7194\u65ad\u5668\u72b6\u6001",children:"\u7194\u65ad\u5668\u72b6\u6001"}),"\n",(0,i.jsx)(n.p,{children:"\u7194\u65ad\u5668\u6709\u4e09\u79cd\u72b6\u6001\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type State int\r\n\r\nconst (\r\n    StateClosed   State = iota // \u5173\u95ed\u72b6\u6001\uff0c\u5141\u8bb8\u8bf7\u6c42\u901a\u8fc7\r\n    StateOpen                  // \u6253\u5f00\u72b6\u6001\uff0c\u8bf7\u6c42\u88ab\u62d2\u7edd\r\n    StateHalfOpen              // \u534a\u5f00\u72b6\u6001\uff0c\u5141\u8bb8\u90e8\u5206\u8bf7\u6c42\u901a\u8fc7\u4ee5\u63a2\u6d4b\u670d\u52a1\u662f\u5426\u6062\u590d\r\n)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u7194\u65ad\u5668\u5b9e\u73b0",children:"\u7194\u65ad\u5668\u5b9e\u73b0"}),"\n",(0,i.jsxs)(n.p,{children:["fyerrpc\u9ed8\u8ba4\u4f7f\u7528",(0,i.jsx)(n.code,{children:"SimpleCircuitBreaker"}),"\uff0c\u5176\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\uff1a"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5173\u95ed\u72b6\u6001"}),"\uff1a\u6240\u6709\u8bf7\u6c42\u6b63\u5e38\u901a\u8fc7\uff0c\u4f46\u8bb0\u5f55\u5931\u8d25\u6b21\u6570"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6253\u5f00\u72b6\u6001"}),"\uff1a\u5f53\u8fde\u7eed\u5931\u8d25\u6b21\u6570\u8fbe\u5230\u9608\u503c\u65f6\uff0c\u7194\u65ad\u5668\u6253\u5f00\uff0c\u62d2\u7edd\u6240\u6709\u8bf7\u6c42"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u534a\u5f00\u72b6\u6001"}),"\uff1a\u8d85\u65f6\u540e\u7194\u65ad\u5668\u8fdb\u5165\u534a\u5f00\u72b6\u6001\uff0c\u5141\u8bb8\u6709\u9650\u8bf7\u6c42\u901a\u8fc7"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6062\u590d\u673a\u5236"}),"\uff1a\u534a\u5f00\u72b6\u6001\u4e0b\u8bf7\u6c42\u6210\u529f\u7387\u8fbe\u5230\u9608\u503c\uff0c\u7194\u65ad\u5668\u5173\u95ed\uff1b\u4efb\u4f55\u5931\u8d25\u4f1a\u4f7f\u7194\u65ad\u5668\u91cd\u65b0\u6253\u5f00"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u7194\u65ad\u5668\r\ncircuitBreaker := failover.NewCircuitBreaker(config)\r\n\r\n// \u5224\u65ad\u8bf7\u6c42\u662f\u5426\u5141\u8bb8\u901a\u8fc7\r\nallow, err := circuitBreaker.Allow(ctx, instance)\r\nif !allow {\r\n    log.Printf("Circuit breaker is open for instance %s: %v", instance.Address, err)\r\n    return err\r\n}\r\n\r\n// \u6839\u636e\u8c03\u7528\u7ed3\u679c\u66f4\u65b0\u7194\u65ad\u5668\r\nif callErr := callService(instance); callErr != nil {\r\n    circuitBreaker.MarkFailure(ctx, instance, callErr)\r\n} else {\r\n    circuitBreaker.MarkSuccess(ctx, instance)\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u91cd\u8bd5\u7b56\u7565",children:"\u91cd\u8bd5\u7b56\u7565"}),"\n",(0,i.jsx)(n.p,{children:"\u91cd\u8bd5\u7b56\u7565\u5b9a\u4e49\u4e86\u5f53\u8c03\u7528\u5931\u8d25\u65f6\u5982\u4f55\u8fdb\u884c\u91cd\u8bd5\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"retrypolicy-\u63a5\u53e3",children:"RetryPolicy \u63a5\u53e3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type RetryPolicy interface {\r\n    // ShouldRetry \u51b3\u5b9a\u662f\u5426\u9700\u8981\u91cd\u8bd5\r\n    ShouldRetry(ctx context.Context, attempt int, err error) bool\r\n\r\n    // NextBackoff \u8ba1\u7b97\u4e0b\u4e00\u6b21\u91cd\u8bd5\u7684\u7b49\u5f85\u65f6\u95f4\r\n    NextBackoff(attempt int) time.Duration\r\n\r\n    // MaxAttempts \u8fd4\u56de\u6700\u5927\u91cd\u8bd5\u6b21\u6570\r\n    MaxAttempts() int\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u91cd\u8bd5\u7b56\u7565\u5b9e\u73b0",children:"\u91cd\u8bd5\u7b56\u7565\u5b9e\u73b0"}),"\n",(0,i.jsx)(n.p,{children:"fyerrpc\u63d0\u4f9b\u4e86\u591a\u79cd\u91cd\u8bd5\u7b56\u7565\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SimpleRetryPolicy"}),"\uff1a\u7b80\u5355\u56fa\u5b9a\u95f4\u9694\u91cd\u8bd5"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u7b80\u5355\u91cd\u8bd5\u7b56\u7565(\u6700\u591a\u91cd\u8bd53\u6b21\uff0c\u95f4\u9694100\u6beb\u79d2)\r\nretryPolicy := failover.NewSimpleRetryPolicy(\r\n    3,                      // \u6700\u5927\u91cd\u8bd5\u6b21\u6570\r\n    100*time.Millisecond,   // \u56fa\u5b9a\u91cd\u8bd5\u95f4\u9694\r\n    []string{"timeout"},    // \u53ef\u91cd\u8bd5\u9519\u8bef\u7c7b\u578b\r\n)\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"ExponentialBackoffRetryPolicy"}),"\uff1a\u6307\u6570\u9000\u907f\u91cd\u8bd5\uff0c\u91cd\u8bd5\u95f4\u9694\u968f\u7740\u5c1d\u8bd5\u6b21\u6570\u589e\u52a0\u800c\u6307\u6570\u589e\u52a0"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u6307\u6570\u9000\u907f\u91cd\u8bd5\u7b56\u7565\r\nretryPolicy := failover.NewExponentialBackoffRetryPolicy(\r\n    3,                     // \u6700\u5927\u91cd\u8bd5\u6b21\u6570\r\n    100*time.Millisecond,  // \u521d\u59cb\u91cd\u8bd5\u95f4\u9694\r\n    10*time.Second,        // \u6700\u5927\u91cd\u8bd5\u95f4\u9694\r\n    2.0,                   // \u4e58\u6570\u56e0\u5b50\r\n    []string{"timeout"},   // \u53ef\u91cd\u8bd5\u9519\u8bef\u7c7b\u578b\r\n)\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"JitteredRetryPolicy"}),'\uff1a\u5e26\u968f\u673a\u6296\u52a8\u7684\u91cd\u8bd5\u7b56\u7565\uff0c\u5728\u6307\u6570\u9000\u907f\u57fa\u7840\u4e0a\u589e\u52a0\u968f\u673a\u6296\u52a8\uff0c\u907f\u514d\u591a\u4e2a\u5ba2\u6237\u7aef\u540c\u65f6\u91cd\u8bd5\u5bfc\u81f4\u7684"\u60ca\u7fa4\u6548\u5e94"']}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u5e26\u6296\u52a8\u7684\u91cd\u8bd5\u7b56\u7565\r\nretryPolicy := failover.NewJitteredRetryPolicy(\r\n    3,                     // \u6700\u5927\u91cd\u8bd5\u6b21\u6570\r\n    100*time.Millisecond,  // \u521d\u59cb\u91cd\u8bd5\u95f4\u9694\r\n    10*time.Second,        // \u6700\u5927\u91cd\u8bd5\u95f4\u9694\r\n    2.0,                   // \u4e58\u6570\u56e0\u5b50\r\n    0.2,                   // \u6296\u52a8\u56e0\u5b50(\xb120%)\r\n    []string{"timeout"},   // \u53ef\u91cd\u8bd5\u9519\u8bef\u7c7b\u578b\r\n)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u6062\u590d\u7b56\u7565",children:"\u6062\u590d\u7b56\u7565"}),"\n",(0,i.jsx)(n.p,{children:"\u6062\u590d\u7b56\u7565\u5b9a\u4e49\u4e86\u5982\u4f55\u5c06\u6545\u969c\u5b9e\u4f8b\u6062\u590d\u5230\u53ef\u7528\u72b6\u6001\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"recoverystrategy-\u63a5\u53e3",children:"RecoveryStrategy \u63a5\u53e3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type RecoveryStrategy interface {\r\n    // CanRecover \u5224\u65ad\u5b9e\u4f8b\u662f\u5426\u53ef\u4ee5\u6062\u590d\r\n    CanRecover(ctx context.Context, instance *naming.Instance) bool\r\n\r\n    // Recover \u6062\u590d\u5b9e\u4f8b\r\n    Recover(ctx context.Context, instance *naming.Instance) error\r\n\r\n    // RecoveryDelay \u8fd4\u56de\u6062\u590d\u5c1d\u8bd5\u95f4\u9694\r\n    RecoveryDelay(instance *naming.Instance) time.Duration\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u6062\u590d\u7b56\u7565\u5b9e\u73b0",children:"\u6062\u590d\u7b56\u7565\u5b9e\u73b0"}),"\n",(0,i.jsx)(n.p,{children:"fyerrpc\u63d0\u4f9b\u4e86\u591a\u79cd\u6062\u590d\u7b56\u7565\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"ImmediateRecoveryStrategy"}),"\uff1a\u7acb\u5373\u6062\u590d\u7b56\u7565\uff0c\u53d1\u73b0\u6545\u969c\u540e\u7acb\u5373\u5c1d\u8bd5\u6062\u590d"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"GradualRecoveryStrategy"}),"\uff1a\u6e10\u8fdb\u5f0f\u6062\u590d\u7b56\u7565\uff0c\u5728\u5931\u8d25\u540e\u4f7f\u7528\u9010\u6e10\u589e\u52a0\u7684\u5ef6\u8fdf\u5c1d\u8bd5\u6062\u590d"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// \u521b\u5efa\u6e10\u8fdb\u5f0f\u6062\u590d\u7b56\u7565\r\nrecoveryStrategy := failover.NewGradualRecoveryStrategy(detector, config)\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"ProbingRecoveryStrategy"}),"\uff1a\u63a2\u6d4b\u5f0f\u6062\u590d\u7b56\u7565\uff0c\u5728\u6062\u590d\u524d\u5148\u53d1\u9001\u5c11\u91cf\u8bf7\u6c42\u63a2\u6d4b\u670d\u52a1\u72b6\u6001"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// \u521b\u5efa\u63a2\u6d4b\u5f0f\u6062\u590d\u7b56\u7565\r\nrecoveryStrategy := failover.NewProbingRecoveryStrategy(detector, config)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u4f7f\u7528\u6545\u969c\u8f6c\u79fb",children:"\u4f7f\u7528\u6545\u969c\u8f6c\u79fb"}),"\n",(0,i.jsx)(n.h3,{id:"\u521b\u5efa\u6545\u969c\u8f6c\u79fb\u5904\u7406\u5668",children:"\u521b\u5efa\u6545\u969c\u8f6c\u79fb\u5904\u7406\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u914d\u7f6e\r\nconfig := failover.NewConfig(\r\n    failover.WithMaxRetries(3),\r\n    failover.WithRetryInterval(100*time.Millisecond),\r\n    failover.WithRetryBackoff(1.5, time.Second),\r\n    failover.WithRetryJitter(0.2),\r\n    failover.WithCircuitBreaker(5, 30*time.Second),\r\n    failover.WithFailoverStrategy("next"),\r\n)\r\n\r\n// \u521b\u5efa\u6545\u969c\u8f6c\u79fb\u5904\u7406\u5668\r\nhandler, err := failover.NewFailoverHandler(config)\r\nif err != nil {\r\n    log.Fatalf("Failed to create failover handler: %v", err)\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u6267\u884c\u5e26\u6545\u969c\u8f6c\u79fb\u7684\u8c03\u7528",children:"\u6267\u884c\u5e26\u6545\u969c\u8f6c\u79fb\u7684\u8c03\u7528"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u5f85\u8c03\u7528\u7684\u670d\u52a1\u5b9e\u4f8b\u5217\u8868\r\ninstances := []*naming.Instance{\r\n    {ID: "inst-1", Address: "192.168.1.101:8000", Status: naming.StatusEnabled},\r\n    {ID: "inst-2", Address: "192.168.1.102:8000", Status: naming.StatusEnabled},\r\n    {ID: "inst-3", Address: "192.168.1.103:8000", Status: naming.StatusEnabled},\r\n}\r\n\r\n// \u5b9a\u4e49\u64cd\u4f5c\u51fd\u6570\r\noperation := func(ctx context.Context, instance *naming.Instance) error {\r\n    // \u8c03\u7528\u670d\u52a1...\r\n    return callService(ctx, instance.Address)\r\n}\r\n\r\n// \u6267\u884c\u5e26\u6545\u969c\u8f6c\u79fb\u7684\u8c03\u7528\r\nctx := context.Background()\r\nresult, err := handler.Execute(ctx, instances, operation)\r\nif err != nil {\r\n    log.Printf("Failover call failed: %v", err)\r\n    log.Printf("Tried %d times, failed nodes: %v", result.RetryCount, result.FailedNodes)\r\n} else {\r\n    log.Printf("Call succeeded using instance %s after %d retries",\r\n        result.Instance.Address, result.RetryCount)\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u6545\u969c\u8f6c\u79fb\u7ed3\u679c",children:"\u6545\u969c\u8f6c\u79fb\u7ed3\u679c"}),"\n",(0,i.jsxs)(n.p,{children:["\u6545\u969c\u8f6c\u79fb\u64cd\u4f5c\u7684\u7ed3\u679c\u901a\u8fc7",(0,i.jsx)(n.code,{children:"FailoverResult"}),"\u7ed3\u6784\u8fd4\u56de\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type FailoverResult struct {\r\n    Success     bool             // \u662f\u5426\u6210\u529f\r\n    Instance    *naming.Instance // \u6700\u7ec8\u4f7f\u7528\u7684\u5b9e\u4f8b\r\n    RetryCount  int              // \u91cd\u8bd5\u6b21\u6570\r\n    Duration    time.Duration    // \u64cd\u4f5c\u8017\u65f6\r\n    Error       error            // \u9519\u8bef\u4fe1\u606f\r\n    FailedNodes []string         // \u5931\u8d25\u7684\u8282\u70b9\u5217\u8868\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u6307\u6807\u6536\u96c6\u4e0e\u76d1\u63a7",children:"\u6307\u6807\u6536\u96c6\u4e0e\u76d1\u63a7"}),"\n",(0,i.jsx)(n.p,{children:"fyerrpc\u63d0\u4f9b\u4e86\u6545\u969c\u8f6c\u79fb\u6307\u6807\u6536\u96c6\u529f\u80fd\uff0c\u7528\u4e8e\u76d1\u63a7\u548c\u5206\u6790\u7cfb\u7edf\u5065\u5eb7\u72b6\u6001\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u6307\u6807\u6536\u96c6\u63a5\u53e3",children:"\u6307\u6807\u6536\u96c6\u63a5\u53e3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type MetricsCollector interface {\r\n    // \u589e\u52a0\u91cd\u8bd5\u8ba1\u6570\r\n    IncrementRetries(service string)\r\n\r\n    // \u589e\u52a0\u6545\u969c\u8f6c\u79fb\u8ba1\u6570\r\n    IncrementFailovers(service string, fromInstance, toInstance string)\r\n\r\n    // \u8bb0\u5f55\u6545\u969c\u68c0\u6d4b\u4e8b\u4ef6\r\n    RecordDetection(instance *naming.Instance, status Status)\r\n\r\n    // \u8bb0\u5f55\u7194\u65ad\u5668\u72b6\u6001\u53d8\u66f4\r\n    RecordBreaker(instance *naming.Instance, state State)\r\n\r\n    // \u8bb0\u5f55\u8bf7\u6c42\u5ef6\u8fdf\r\n    RecordLatency(instance *naming.Instance, latency time.Duration)\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668",children:"\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u5185\u5b58\u6307\u6807\u6536\u96c6\u5668(\u4fdd\u7559100\u4e2a\u5ef6\u8fdf\u6837\u672c)\r\ncollector := failover.NewInMemoryMetricsCollector(100)\r\n\r\n// \u83b7\u53d6\u6307\u6807\r\nretryCount := collector.GetRetryCount("user-service")\r\nfailoverCount := collector.GetFailoverCount("user-service")\r\navgLatency := collector.GetAverageLatency("instance-1")\r\n\r\n// \u83b7\u53d6\u6545\u969c\u68c0\u6d4b\u7edf\u8ba1\r\ndetectionStats := collector.GetDetectionStats("instance-1")\r\nhealthyCount := detectionStats[failover.StatusHealthy]\r\nunhealthyCount := detectionStats[failover.StatusUnhealthy]\r\n\r\n// \u83b7\u53d6\u7194\u65ad\u5668\u7edf\u8ba1\r\nbreakerStats := collector.GetBreakerStats("instance-1")\r\nopenCount := breakerStats[failover.StateOpen]\n'})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>s});var t=r(6540);const i={},l=t.createContext(i);function c(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);