# protocol

# 1.概览

`protocol`模块是fyer-rpc框架的核心通信层，负责处理消息的编码和解码。它定义了通信协议格式，实现了不同序列化方式的消息处理，确保客户端和服务端能够正确地进行数据交换。主要功能包括：

# 2.目录结构

`protocol`模块的目录结构如下：

```
protocol/
├── codec/
│   ├── codec.go    // 编解码器接口定义和注册管理
│   ├── json.go     // JSON编解码器实现
│   └── proto.go    // Protobuf编解码器实现
├── header.go       // 消息头部定义和常量
├── message.go      // 消息结构定义
├── protocol.go     // 协议编解码实现
└── error.go        // 错误类型定义
```

# 3.核心功能

`protocol`模块实现了如下的功能：

* 定义统一的消息格式和头部结构
* 实现消息的序列化和反序列化
* 提供多种编解码方式（JSON、Protobuf）
* 处理消息的编码和解码流程

# 4.组件设计

`protocol`模块设计了一个二进制通信协议，包含以下部分：

* **固定长度的消息头部（22字节）**：包含魔数、版本号、消息类型、压缩类型、序列化类型、消息ID以及元数据和消息体的长度信息。

* **可变长度的元数据**：包含服务名称、方法名称、错误信息等RPC调用相关信息。

* **可变长度的消息体**：包含请求参数或响应结果。

消息格式如下：

```
+------------------+
|     Header       |  消息头部（固定22字节）
+------------------+
|    Metadata      |  元数据(可变长度)，包含服务名、方法名等信息
+------------------+
|    Payload       |  消息体(可变长度)，包含请求参数或响应结果
+------------------+
```

头部格式（按字节划分）如下：

```
+-----------------------------------------------+
|  magic number   |  version    |  msg type     |
+-----------------------------------------------+
|  2 bytes        |  1 byte     |  1 byte       |
+-----------------------------------------------+
|  compress type  |  serial type|  message id   |
+-----------------------------------------------+
|  1 byte         |  1 byte     |  8 bytes      |
+-----------------------------------------------+
|  metadata size  |  payload size               |
+-----------------------------------------------+
|  4 bytes        |  4 bytes                    |
+-----------------------------------------------+
```
